<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ball Planet - Jogo de Formas Geom√©tricas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P:wght@400&display=swap');
        
        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            overflow-x: hidden;
        }
        
        .pixel-font {
            font-family: 'Press Start 2P', cursive;
        }
        
        .game-button {
            transition: all 0.2s ease;
            image-rendering: pixelated;
        }
        
        .game-button:hover {
            transform: scale(1.05);
        }
        
        .game-button:active {
            transform: scale(0.95);
        }
        
        #gameCanvas {
            border: 3px solid #333;
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%);
            max-width: 100vw;
            max-height: 70vh;
            width: auto;
            height: auto;
        }
        
        .mobile-control {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.8);
            color: white;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        
        .mobile-control:active {
            background: rgba(255, 255, 255, 0.3);
        }

        .shield-button {
            background: rgba(0, 100, 255, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .laser-button {
            background: rgba(255, 100, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .sword-button {
            background: rgba(255, 0, 100, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .boss-health-bar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #fff;
            z-index: 10;
        }

        .game-container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        #mobileControls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px;
            z-index: 20;
        }

        .warning-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #fff;
            z-index: 30;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .scrollable-screen {
            min-height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            scroll-behavior: smooth;
        }
        
        #shopScreen, #achievementsScreen {
            min-height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            scroll-behavior: smooth;
            padding-bottom: 50px;
        }

        .vine-trapped {
            animation: shake 0.1s infinite;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
            100% { transform: translateX(0); }
        }

        .save-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 255, 0, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-notification.show {
            opacity: 1;
        }

        /* NOVO: Part√≠culas */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            pointer-events: none;
            z-index: 5;
        }

        @keyframes particleExplosion {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.2);
            }
        }

        /* NOVO: Bot√µes de navega√ß√£o fixos para mobile */
        .mobile-nav-buttons {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-button {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        .nav-button:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.9);
        }

        @media (max-width: 768px) {
            #gameCanvas {
                max-height: 60vh;
            }
            
            #mobileControls {
                padding: 8px;
            }

            .mobile-nav-buttons {
                display: flex;
            }
        }

        @media (min-width: 769px) {
            .mobile-nav-buttons {
                display: none;
            }
        }

        /* NOVO: Melhorias visuais - Glow effects */
        .glow-effect {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            }
            to {
                box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
            }
        }

        /* Efeitos visuais melhorados */
        .boss-segment-damage {
            animation: segment-hit 0.2s ease;
        }

        @keyframes segment-hit {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); background-color: #ff0000; }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="overflow-hidden">
    <!-- Save Notification -->
    <div id="saveNotification" class="save-notification pixel-font text-xs">
        Progresso Salvo!
    </div>

    <!-- Mobile Navigation Buttons -->
    <div class="mobile-nav-buttons">
        <button id="scrollUpBtn" class="nav-button">‚Üë</button>
        <button id="scrollDownBtn" class="nav-button">‚Üì</button>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu" class="min-h-screen flex flex-col justify-center items-center bg-gradient-to-br from-purple-600 to-blue-600">
        <h1 class="text-4xl md:text-6xl text-white mb-8 pixel-font text-center glow-effect">BALL PLANET</h1>
        <div class="space-y-4">
            <button id="playButton" class="game-button bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-lg text-lg pixel-font">
                JOGAR
            </button>
            <button id="shopButton" class="game-button bg-yellow-500 hover:bg-yellow-600 text-white px-8 py-4 rounded-lg text-lg pixel-font">
                LOJA
            </button>
            <button id="achievementsButton" class="game-button bg-purple-500 hover:bg-purple-600 text-white px-8 py-4 rounded-lg text-lg pixel-font">
                CONQUISTAS
            </button>
            <button id="resetSaveButton" class="game-button bg-red-700 hover:bg-red-800 text-white px-6 py-2 rounded-lg text-sm pixel-font">
                RESETAR SAVE
            </button>
        </div>
        <div class="mt-8 text-white pixel-font text-sm">
            Dinheiro: <span id="moneyDisplay">0</span> üí∞
        </div>
    </div>

    <!-- Shop Screen -->
    <div id="shopScreen" class="min-h-screen scrollable-screen p-4 bg-gradient-to-br from-yellow-600 to-orange-600 hidden">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <button id="backToMenuFromShop" class="game-button bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded pixel-font text-sm">
                    VOLTAR
                </button>
                <h2 class="text-2xl md:text-4xl text-white pixel-font">LOJA</h2>
                <div class="text-white pixel-font text-sm">üí∞ <span id="shopMoneyDisplay">0</span></div>
            </div>
            
            <!-- Shopkeeper -->
            <div class="bg-white/20 p-6 rounded-lg border-2 border-white/30 mb-8">
                <div class="flex items-center justify-center mb-4">
                    <canvas id="shopkeeperCanvas" width="120" height="120" class="border-2 border-white rounded"></canvas>
                </div>
                <div id="shopkeeperText" class="text-white pixel-font text-sm text-center">
                    "Opa cidad√£o, precisa de algo?"
                </div>
            </div>

            <!-- Shop Items -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Shield Item - 100 moedas -->
                <div class="bg-white/20 p-6 rounded-lg border-2 border-white/30">
                    <h3 class="text-white pixel-font text-lg mb-2">üõ°Ô∏è ESCUDO PROTETOR</h3>
                    <p class="text-white pixel-font text-xs mb-4">Fica imortal por 5 segundos. Cooldown: 25s</p>
                    <p class="text-yellow-300 pixel-font text-sm mb-4">üí∞ 100 moedas</p>
                    <button id="buyShield" class="game-button bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded pixel-font text-sm w-full">
                        COMPRAR
                    </button>
                    <div id="shieldOwned" class="text-green-400 pixel-font text-xs mt-2 hidden">‚úÖ COMPRADO</div>
                </div>

                <!-- Extra Life Item - 250 moedas -->
                <div class="bg-white/20 p-6 rounded-lg border-2 border-white/30">
                    <h3 class="text-white pixel-font text-lg mb-2">‚ù§Ô∏è VIDA EXTRA!</h3>
                    <p class="text-white pixel-font text-xs mb-4">Aumenta sua vida m√°xima em 50 HP</p>
                    <p class="text-yellow-300 pixel-font text-sm mb-4">üí∞ 250 moedas</p>
                    <button id="buyExtraLife" class="game-button bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded pixel-font text-sm w-full">
                        COMPRAR
                    </button>
                    <div id="extraLifeOwned" class="text-green-400 pixel-font text-xs mt-2 hidden">‚úÖ COMPRADO</div>
                </div>

                <!-- Shot Upgrade Item - 300 moedas -->
                <div class="bg-white/20 p-6 rounded-lg border-2 border-white/30">
                    <h3 class="text-white pixel-font text-lg mb-2">üî´ MELHORIA DE TIRO</h3>
                    <p class="text-white pixel-font text-xs mb-4">Seus tiros passam a dar 2 de dano ao inv√©s de 1</p>
                    <p class="text-yellow-300 pixel-font text-sm mb-4">üí∞ 300 moedas</p>
                    <button id="buyShotUpgrade" class="game-button bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded pixel-font text-sm w-full">
                        COMPRAR
                    </button>
                    <div id="shotUpgradeOwned" class="text-green-400 pixel-font text-xs mt-2 hidden">‚úÖ COMPRADO</div>
                </div>

                <!-- Laser Item - 400 moedas -->
                <div class="bg-white/20 p-6 rounded-lg border-2 border-white/30">
                    <h3 class="text-white pixel-font text-lg mb-2">‚ö° TIRO ESPECIAL</h3>
                    <p class="text-white pixel-font text-xs mb-4">Laser azul devastador. Requer 20+ dano causado</p>
                    <p class="text-yellow-300 pixel-font text-sm mb-4">üí∞ 400 moedas</p>
                    <button id="buyLaser" class="game-button bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded pixel-font text-sm w-full">
                        COMPRAR
                    </button>
                    <div id="laserOwned" class="text-green-400 pixel-font text-xs mt-2 hidden">‚úÖ COMPRADO</div>
                </div>

                <!-- Life Upgrade - 500 moedas -->
                <div class="bg-white/20 p-6 rounded-lg border-2 border-white/30">
                    <h3 class="text-white pixel-font text-lg mb-2">üíñ VIDA SUPREMA</h3>
                    <p class="text-white pixel-font text-xs mb-4">Upgrade: Vida m√°xima vira 200 HP total! (Requer Vida Extra)</p>
                    <p class="text-yellow-300 pixel-font text-sm mb-4">üí∞ 500 moedas</p>
                    <button id="buyLifeUpgrade" class="game-button bg-red-700 hover:bg-red-800 text-white px-6 py-3 rounded pixel-font text-sm w-full">
                        COMPRAR
                    </button>
                    <div id="lifeUpgradeOwned" class="text-green-400 pixel-font text-xs mt-2 hidden">‚úÖ COMPRADO</div>
                </div>

                <!-- Shot Master Upgrade - 600 moedas -->
                <div class="bg-white/20 p-6 rounded-lg border-2 border-white/30">
                    <h3 class="text-white pixel-font text-lg mb-2">üéØ TIRO MESTRE</h3>
                    <p class="text-white pixel-font text-xs mb-4">Upgrade: Tiros causam 3 de dano! (Requer Melhoria de Tiro)</p>
                    <p class="text-yellow-300 pixel-font text-sm mb-4">üí∞ 600 moedas</p>
                    <button id="buyShotMaster" class="game-button bg-orange-700 hover:bg-orange-800 text-white px-6 py-3 rounded pixel-font text-sm w-full">
                        COMPRAR
                    </button>
                    <div id="shotMasterOwned" class="text-green-400 pixel-font text-xs mt-2 hidden">‚úÖ COMPRADO</div>
                </div>

                <!-- Sword Rain Item - 800 moedas -->
                <div class="bg-white/20 p-6 rounded-lg border-2 border-white/30">
                    <h3 class="text-white pixel-font text-lg mb-2">‚öîÔ∏è CHUVA DE ESPADAS</h3>
                    <p class="text-white pixel-font text-xs mb-4">15 espadas surgem de portais! 1x por fase</p>
                    <p class="text-yellow-300 pixel-font text-sm mb-4">üí∞ 800 moedas</p>
                    <button id="buySwordRain" class="game-button bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded pixel-font text-sm w-full">
                        COMPRAR
                    </button>
                    <div id="swordRainOwned" class="text-green-400 pixel-font text-xs mt-2 hidden">‚úÖ COMPRADO</div>
                </div>

                <!-- Laser Upgrade - 1000 moedas -->
                <div class="bg-white/20 p-6 rounded-lg border-2 border-white/30">
                    <h3 class="text-white pixel-font text-lg mb-2">‚ö° LASER SUPREMO</h3>
                    <p class="text-white pixel-font text-xs mb-4">Upgrade: Laser causa 100 de dano ao inv√©s de 50! (Requer Tiro Especial)</p>
                    <p class="text-yellow-300 pixel-font text-sm mb-4">üí∞ 1000 moedas</p>
                    <button id="buyLaserUpgrade" class="game-button bg-cyan-700 hover:bg-cyan-800 text-white px-6 py-3 rounded pixel-font text-sm w-full">
                        COMPRAR
                    </button>
                    <div id="laserUpgradeOwned" class="text-green-400 pixel-font text-xs mt-2 hidden">‚úÖ COMPRADO</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Screen -->
    <div id="achievementsScreen" class="min-h-screen scrollable-screen p-4 bg-gradient-to-br from-purple-600 to-indigo-700 hidden">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <button id="backToMenuFromAchievements" class="game-button bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded pixel-font text-sm">
                    VOLTAR
                </button>
                <h2 class="text-2xl md:text-4xl text-white pixel-font">CONQUISTAS</h2>
                <div class="text-white pixel-font text-sm">
                    <span id="achievementsProgress">0/10</span> Descobertas
                </div>
            </div>
            
            <!-- Achievements Grid -->
            <div id="achievementsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Achievements will be dynamically populated -->
            </div>
        </div>
    </div>

    <!-- Level Selection -->
    <div id="levelSelect" class="min-h-screen p-4 bg-gradient-to-br from-indigo-600 to-purple-600 hidden">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <button id="backToMenu" class="game-button bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded pixel-font text-sm">
                    VOLTAR
                </button>
                <h2 class="text-2xl md:text-4xl text-white pixel-font">MUNDO 1 - PLANETA BOLA</h2>
                <div class="text-white pixel-font text-sm">
                    üí∞ <span id="moneyDisplay2">0</span>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="level-item bg-white/20 p-4 rounded-lg border-2 border-white/30">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üåç</div>
                        <div class="text-white pixel-font text-xs mb-2">FASE 1</div>
                        <button id="level1Button" class="game-button bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded pixel-font text-xs">
                            SELECIONAR
                        </button>
                    </div>
                </div>
                
                <div id="level2Container" class="level-item bg-gray-600/50 p-4 rounded-lg border-2 border-gray-400/30">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üîí</div>
                        <div class="text-gray-300 pixel-font text-xs mb-2">FASE 2</div>
                        <div class="text-gray-400 pixel-font text-xs">BLOQUEADA</div>
                    </div>
                </div>
                
                <div id="level3Container" class="level-item bg-gray-600/50 p-4 rounded-lg border-2 border-gray-400/30">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üîí</div>
                        <div class="text-gray-300 pixel-font text-xs mb-2">FASE 3</div>
                        <div class="text-gray-400 pixel-font text-xs">BLOQUEADA</div>
                    </div>
                </div>
                
                <div id="level4Container" class="level-item bg-gray-600/50 p-4 rounded-lg border-2 border-gray-400/30">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üîí</div>
                        <div class="text-gray-300 pixel-font text-xs mb-2">FASE 4</div>
                        <div class="text-gray-400 pixel-font text-xs">BLOQUEADA</div>
                    </div>
                </div>
            </div>

            <!-- World 2 Button -->
            <div id="world2Button" class="mt-8 text-center hidden">
                <button id="goToWorld2" class="game-button bg-purple-700 hover:bg-purple-800 text-white px-8 py-4 rounded-lg pixel-font text-lg">
                    üöÄ MUNDO 2 - PLANETA QUADRADO
                </button>
            </div>
        </div>
    </div>

    <!-- World 2 Level Selection -->
    <div id="world2Select" class="min-h-screen p-4 bg-gradient-to-br from-green-600 to-teal-600 hidden">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <button id="backToWorld1" class="game-button bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded pixel-font text-sm">
                    VOLTAR
                </button>
                <h2 class="text-2xl md:text-4xl text-white pixel-font">MUNDO 2 - PLANETA QUADRADO</h2>
                <div class="text-white pixel-font text-sm">
                    üí∞ <span id="moneyDisplay3">0</span> | üîµ <span id="ballsDisplay">0</span> Bolas Salvas
                </div>
            </div>
            
            <!-- ADICIONADO: Explica√ß√£o das bolas -->
            <div class="bg-white/20 p-4 rounded-lg border-2 border-white/30 mb-6">
                <h3 class="text-yellow-300 pixel-font text-sm mb-2">üìñ SOBRE AS BOLAS SALVAS</h3>
                <p class="text-white pixel-font text-xs">
                    üîµ Bolas salvas desbloqueiam fases! Fase 7 requer 4 bolas, Fase 8 requer 10 bolas.
                    Destrua naves na Fase 6 para salv√°-las (50% chance de drop por nave).
                </p>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div id="world2Level1Container" class="level-item bg-white/20 p-4 rounded-lg border-2 border-white/30">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üå≤</div>
                        <div class="text-white pixel-font text-xs mb-2">FASE 5</div>
                        <button id="world2Level1Button" class="game-button bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded pixel-font text-xs">
                            SELECIONAR
                        </button>
                    </div>
                </div>
                
                <div id="world2Level2Container" class="level-item bg-gray-600/50 p-4 rounded-lg border-2 border-gray-400/30">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üîí</div>
                        <div class="text-gray-300 pixel-font text-xs mb-2">FASE 6</div>
                        <div class="text-gray-400 pixel-font text-xs">BLOQUEADA</div>
                    </div>
                </div>
                
                <div id="world2Level3Container" class="level-item bg-gray-600/50 p-4 rounded-lg border-2 border-gray-400/30">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üîí</div>
                        <div class="text-gray-300 pixel-font text-xs mb-2">FASE 7</div>
                        <div class="text-gray-400 pixel-font text-xs">BLOQUEADA</div>
                    </div>
                </div>
                
                <div id="world2Level4Container" class="level-item bg-gray-600/50 p-4 rounded-lg border-2 border-gray-400/30">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üîí</div>
                        <div class="text-gray-300 pixel-font text-xs mb-2">FASE 8</div>
                        <div class="text-gray-400 pixel-font text-xs">BLOQUEADA</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Level Description -->
    <div id="levelDescription" class="min-h-screen flex flex-col justify-center items-center bg-gradient-to-br from-blue-700 to-indigo-800 hidden">
        <div class="bg-white/10 p-8 rounded-lg border-2 border-white/30 max-w-2xl">
            <h3 id="levelTitle" class="text-2xl text-white pixel-font mb-4 text-center">FASE 1</h3>
            <p id="levelDesc" class="text-white pixel-font text-sm mb-6 text-center leading-relaxed">
                Em um lugar onde s√≥ existem bolas, algo triangular aparece...
            </p>
            <div class="flex justify-center space-x-4">
                <button id="backToLevels" class="game-button bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded pixel-font text-sm">
                    VOLTAR
                </button>
                <button id="enterLevel" class="game-button bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded pixel-font text-sm">
                    ENTRAR
                </button>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden">
        <div class="game-container">
            <canvas id="gameCanvas" width="800" height="600"></canvas>
        </div>
        
        <!-- Boss Health Bar -->
        <div id="bossHealthBar" class="boss-health-bar hidden">
            <div class="text-white pixel-font text-xs mb-2 text-center" id="bossName">BOLA DONA</div>
            <div class="w-64 h-4 bg-red-800 border-2 border-white rounded">
                <div id="bossHealth" class="h-full bg-red-500 rounded transition-all duration-300" style="width: 100%"></div>
            </div>
            <!-- NOVO: Indicador de segmentos destru√≠dos -->
            <div id="segmentInfo" class="text-white pixel-font text-xs text-center mt-1 hidden">
                Segmentos: <span id="segmentCount">0/7</span> | Cabe√ßa: <span id="headStatus">Protegida</span>
            </div>
        </div>

        <!-- Boss Warning -->
        <div id="bossWarning" class="warning-text hidden">
            <div class="text-white pixel-font text-lg">‚ö†Ô∏è CUIDADO! ‚ö†Ô∏è</div>
        </div>

        <!-- Tentacle Warning -->
        <div id="tentacleWarning" class="warning-text hidden">
            <div class="text-white pixel-font text-lg">üåø TENT√ÅCULOS! üåø</div>
        </div>
        
        <!-- Mobile Controls -->
        <div id="mobileControls" class="md:hidden">
            <div class="flex justify-between items-center">
                <!-- Movement Controls -->
                <div class="flex space-x-2">
                    <button id="leftBtn" class="mobile-control w-16 h-16 rounded-full flex items-center justify-center pixel-font text-xl">‚Üê</button>
                    <button id="rightBtn" class="mobile-control w-16 h-16 rounded-full flex items-center justify-center pixel-font text-xl">‚Üí</button>
                </div>
                
                <!-- Aim and Shoot Controls -->
                <div class="flex flex-col items-center space-y-2">
                    <!-- Aim Controls -->
                    <div class="grid grid-cols-3 gap-1">
                        <button id="aimUpLeft" class="mobile-control w-12 h-12 rounded flex items-center justify-center text-xs">‚Üñ</button>
                        <button id="aimUp" class="mobile-control w-12 h-12 rounded flex items-center justify-center text-xs">‚Üë</button>
                        <button id="aimUpRight" class="mobile-control w-12 h-12 rounded flex items-center justify-center text-xs">‚Üó</button>
                        <button id="aimLeft" class="mobile-control w-12 h-12 rounded flex items-center justify-center text-xs">‚Üê</button>
                        <div class="w-12 h-12"></div>
                        <button id="aimRight" class="mobile-control w-12 h-12 rounded flex items-center justify-center text-xs">‚Üí</button>
                    </div>
                    <!-- Shoot Button -->
                    <button id="shoot" class="mobile-control w-16 h-16 rounded-full flex items-center justify-center text-lg bg-red-600">üî´</button>
                </div>

                <!-- Special Abilities -->
                <div class="flex flex-col space-y-2">
                    <button id="shieldBtn" class="shield-button w-16 h-16 rounded-full flex items-center justify-center pixel-font text-sm hidden">üõ°Ô∏è</button>
                    <button id="laserBtn" class="laser-button w-16 h-16 rounded-full flex items-center justify-center pixel-font text-sm hidden">‚ö°</button>
                    <button id="swordBtn" class="sword-button w-16 h-16 rounded-full flex items-center justify-center pixel-font text-sm hidden">‚öîÔ∏è</button>
                </div>
            </div>
        </div>
        
        <!-- Game UI -->
        <div class="fixed top-4 left-4 text-white pixel-font text-sm z-10">
            <div>HP: <span id="playerHP">100</span>/<span id="playerMaxHP">100</span></div>
            <div>Dinheiro: <span id="gameMoneyDisplay">0</span> üí∞</div>
            <div id="gameTimeContainer">Tempo: <span id="gameTime">30</span>s</div>
            <div>Dano Total: <span id="gameDamageDisplay">0</span></div>
            <div id="swordUsesContainer" class="hidden">Espadas: <span id="swordUses">1</span>/1</div>
            <div id="ballsContainer" class="hidden">üîµ Bolas: <span id="gameBallsDisplay">0</span></div>
        </div>
        
        <div class="fixed top-4 right-4 z-10">
            <button id="pauseBtn" class="mobile-control px-4 py-2 rounded pixel-font text-sm">PAUSE</button>
        </div>
    </div>

    <!-- Achievement Notification -->
    <div id="achievementNotification" class="fixed top-4 right-4 bg-black/90 p-4 rounded-lg border-2 border-yellow-400 hidden z-50 max-w-xs">
        <div class="text-center">
            <div class="text-yellow-400 pixel-font text-sm mb-1">NOVA DESCOBERTA!</div>
            <div id="achievementIcon" class="text-2xl mb-1">üîµ</div>
            <div id="achievementName" class="text-white pixel-font text-xs mb-1">Inimigo Azul</div>
            <div id="achievementDesc" class="text-gray-300 pixel-font text-xs">Pequeno quadrado azul que persegue o jogador.</div>
        </div>
    </div>

    <!-- Cutscene Overlay -->
    <div id="cutsceneOverlay" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50">
        <div class="bg-black/90 p-6 rounded-lg border-2 border-white/30 max-w-2xl">
            <div id="cutsceneContent" class="text-white pixel-font text-sm text-center"></div>
            <button id="skipCutscene" class="mt-4 game-button bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded pixel-font text-xs mx-auto block">
                PULAR
            </button>
        </div>
    </div>

    <!-- Pause Menu -->
    <div id="pauseMenu" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-40">
        <div class="bg-white/10 p-8 rounded-lg border-2 border-white/30">
            <h3 class="text-2xl text-white pixel-font mb-4 text-center">PAUSADO</h3>
            <div class="space-y-3">
                <button id="resumeBtn" class="game-button bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded pixel-font text-sm w-full">
                    CONTINUAR
                </button>
                <button id="quitBtn" class="game-button bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded pixel-font text-sm w-full">
                    SAIR
                </button>
            </div>
        </div>
    </div>

    <script>
        // Hide console
        if (typeof console !== 'undefined') {
            console.log = console.warn = console.error = () => {};
        }

        // NOVO: Sistema de Part√≠culas
        let particles = [];

        function createParticles(x, y, color = '#FFD700', count = 8) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    color: color,
                    life: 1.0,
                    decay: 0.02 + Math.random() * 0.03,
                    size: 2 + Math.random() * 4
                });
            }
        }

        function updateParticles() {
            particles.forEach((particle, index) => {
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.vx *= 0.98;
                particle.vy *= 0.98;
                particle.life -= particle.decay;
                
                if (particle.life <= 0) {
                    particles.splice(index, 1);
                }
            });
        }

        function renderParticles() {
            particles.forEach(particle => {
                ctx.globalAlpha = particle.life;
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size * particle.life, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;
        }

        // NOVO: Sistema de Save
        function saveGame() {
            const saveData = {
                money: gameState.money,
                ballsSaved: gameState.ballsSaved,
                level1Completed: gameState.level1Completed,
                level2Completed: gameState.level2Completed,
                level3Completed: gameState.level3Completed,
                level4Completed: gameState.level4Completed,
                world2Level1Completed: gameState.world2Level1Completed,
                world2Level2Completed: gameState.world2Level2Completed,
                world2Level3Completed: gameState.world2Level3Completed,
                world2Level4Completed: gameState.world2Level4Completed,
                hasShield: gameState.hasShield,
                hasLaser: gameState.hasLaser,
                hasExtraLife: gameState.hasExtraLife,
                hasSwordRain: gameState.hasSwordRain,
                hasShotUpgrade: gameState.hasShotUpgrade,
                hasLifeUpgrade: gameState.hasLifeUpgrade,
                hasShotMaster: gameState.hasShotMaster,
                hasLaserUpgrade: gameState.hasLaserUpgrade,
                achievements: achievements
            };
            
            try {
                localStorage.setItem('ballPlanetSave', JSON.stringify(saveData));
                showSaveNotification();
            } catch (e) {
                console.error('Erro ao salvar:', e);
            }
        }

        function loadGame() {
            try {
                const saveData = localStorage.getItem('ballPlanetSave');
                if (saveData) {
                    const data = JSON.parse(saveData);
                    
                    gameState.money = data.money || 0;
                    gameState.ballsSaved = data.ballsSaved || 0;
                    gameState.level1Completed = data.level1Completed || false;
                    gameState.level2Completed = data.level2Completed || false;
                    gameState.level3Completed = data.level3Completed || false;
                    gameState.level4Completed = data.level4Completed || false;
                    gameState.world2Level1Completed = data.world2Level1Completed || false;
                    gameState.world2Level2Completed = data.world2Level2Completed || false;
                    gameState.world2Level3Completed = data.world2Level3Completed || false;
                    gameState.world2Level4Completed = data.world2Level4Completed || false;
                    gameState.hasShield = data.hasShield || false;
                    gameState.hasLaser = data.hasLaser || false;
                    gameState.hasExtraLife = data.hasExtraLife || false;
                    gameState.hasSwordRain = data.hasSwordRain || false;
                    gameState.hasShotUpgrade = data.hasShotUpgrade || false;
                    gameState.hasLifeUpgrade = data.hasLifeUpgrade || false;
                    gameState.hasShotMaster = data.hasShotMaster || false;
                    gameState.hasLaserUpgrade = data.hasLaserUpgrade || false;
                    
                    if (data.achievements) {
                        achievements = data.achievements;
                    }
                    
                    return true;
                }
            } catch (e) {
                console.error('Erro ao carregar save:', e);
            }
            return false;
        }

        function resetSave() {
            if (confirm('Tem certeza que deseja resetar todo o progresso? Esta a√ß√£o n√£o pode ser desfeita!')) {
                localStorage.removeItem('ballPlanetSave');
                location.reload();
            }
        }

        function showSaveNotification() {
            const notification = document.getElementById('saveNotification');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        // NOVO: Sistema de navega√ß√£o mobile
        function setupMobileNavigation() {
            const scrollUpBtn = document.getElementById('scrollUpBtn');
            const scrollDownBtn = document.getElementById('scrollDownBtn');
            
            scrollUpBtn.addEventListener('click', () => {
                window.scrollBy({ top: -300, behavior: 'smooth' });
            });
            
            scrollDownBtn.addEventListener('click', () => {
                window.scrollBy({ top: 300, behavior: 'smooth' });
            });
        }

        // Achievements system (expanded)
        let achievements = {
            small_enemy: {
                name: "Inimigo Azul",
                icon: "üîµ",
                description: "Pequeno quadrado azul que persegue o jogador. Fraco mas perigoso em grupo.",
                discovered: false
            },
            big_enemy: {
                name: "Inimigo Grande",
                icon: "üü¶",
                description: "Quadrado azul maior que atira proj√©teis vermelhos no jogador. Fica parado mas √© perigoso √† dist√¢ncia.",
                discovered: false
            },
            rolling_enemy: {
                name: "Bola Verde Rolante",
                icon: "üü¢",
                description: "Bola verde que rola pelo ch√£o causando muito dano. Move-se em linha reta e √© dif√≠cil de evitar.",
                discovered: false
            },
            rectangle_enemy: {
                name: "Ret√¢ngulo Venenoso",
                icon: "üü©",
                description: "Inimigo retangular verde que atira proj√©teis venenosos roxos. Vem do planeta quadrado.",
                discovered: false
            },
            boss_enemy: {
                name: "Bola Dona",
                icon: "üî¥",
                description: "Chefe das bolas do planeta. Pode lan√ßar bombas, bater no ch√£o e invocar servos. Fica mais forte quando ferida.",
                discovered: false
            },
            minion_enemy: {
                name: "Servo da Bola Dona",
                icon: "üü†",
                description: "Pequenas bolas laranja invocadas pela Bola Dona. Perseguem o jogador e causam dano moderado.",
                discovered: false
            },
            bomb: {
                name: "Bomba",
                icon: "üí£",
                description: "Proj√©til explosivo laranja lan√ßado pela Bola Dona. Pode ser destru√≠da com tiros antes de explodir.",
                discovered: false
            },
            poison_bullet: {
                name: "Proj√©til Venenoso",
                icon: "üü£",
                description: "Bala roxa venenosa disparada por ret√¢ngulos. Causa mais dano que proj√©teis normais.",
                discovered: false
            },
            vine_enemy: {
                name: "Armadilha de Vinha",
                icon: "üåø",
                description: "Armadilha de planta que prende o jogador por 2 segundos. N√£o causa dano mas impede de atirar.",
                discovered: false
            },
            snake_boss: {
                name: "Cobra dos Quadrados",
                icon: "üêç",
                description: "Boss supremo do planeta quadrado. Uma cobra gigante feita de ret√¢ngulos verdes com ataques devastadores.",
                discovered: false
            }
        };

        function discoverAchievement(type) {
            if (!achievements[type] || achievements[type].discovered) return;
            
            achievements[type].discovered = true;
            showAchievementNotification(achievements[type]);
            updateAchievementsScreen();
            saveGame();
        }

        function showAchievementNotification(achievement) {
            document.getElementById('achievementIcon').textContent = achievement.icon;
            document.getElementById('achievementName').textContent = achievement.name;
            document.getElementById('achievementDesc').textContent = achievement.description;
            document.getElementById('achievementNotification').classList.remove('hidden');
            
            setTimeout(() => {
                document.getElementById('achievementNotification').classList.add('hidden');
            }, 4000);
        }

        function updateAchievementsScreen() {
            const grid = document.getElementById('achievementsGrid');
            const discovered = Object.values(achievements).filter(a => a.discovered).length;
            const total = Object.keys(achievements).length;
            
            document.getElementById('achievementsProgress').textContent = `${discovered}/${total}`;
            
            grid.innerHTML = '';
            
            Object.entries(achievements).forEach(([key, achievement]) => {
                const achievementDiv = document.createElement('div');
                achievementDiv.className = achievement.discovered 
                    ? 'bg-white/20 p-4 rounded-lg border-2 border-white/30'
                    : 'bg-gray-600/50 p-4 rounded-lg border-2 border-gray-400/30';
                
                achievementDiv.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-2">${achievement.discovered ? achievement.icon : '‚ùì'}</div>
                        <div class="text-white pixel-font text-sm mb-2">${achievement.discovered ? achievement.name : '???'}</div>
                        <div class="text-gray-300 pixel-font text-xs">${achievement.discovered ? achievement.description : 'Derrote este inimigo para descobrir'}</div>
                    </div>
                `;
                
                grid.appendChild(achievementDiv);
            });
        }

        // Game State
        let gameState = {
            screen: 'menu',
            money: 0,
            ballsSaved: 0,
            currentLevel: 1,
            currentWorld: 1,
            gameRunning: false,
            paused: false,
            cutsceneActive: false,
            level1Completed: false,
            level2Completed: false,
            level3Completed: false,
            level4Completed: false,
            world2Level1Completed: false,
            world2Level2Completed: false,
            world2Level3Completed: false,
            world2Level4Completed: false,
            level2Unlocked: false,
            level3Unlocked: false,
            level4Unlocked: false,
            world2Unlocked: false,
            world2Level2Unlocked: false,
            world2Level3Unlocked: false,
            world2Level4Unlocked: false,
            totalDamageDealt: 0,
            
            // Shop items
            hasShield: false,
            hasLaser: false,
            hasExtraLife: false,
            hasSwordRain: false,
            hasShotUpgrade: false,
            hasLifeUpgrade: false,
            hasShotMaster: false,
            hasLaserUpgrade: false,
            
            // Abilities state
            shieldActive: false,
            shieldCooldown: 0,
            shieldDuration: 0,
            swordRainUsesLeft: 0,
            vineTrapped: false,
            vineTrapDuration: 0
        };

        // Game Objects
        let player = {
            x: 400,
            y: 500,
            width: 30,
            height: 30,
            hp: 100,
            maxHP: 100,
            speed: 5,
            aimDirection: { x: 0, y: -1 }
        };

        let bullets = [];
        let enemies = [];
        let lasers = [];
        let bombs = [];
        let boss = null;
        let gameTime = 30;
        let lastEnemySpawn = 0;
        let lastBigEnemySpawn = 0;
        let lastRollingEnemySpawn = 0;
        let floatingTexts = [];
        let enemySpawnPaused = false;
        let swords = [];
        let fingerSnapEffect = null;
        let portals = [];
        let vines = [];
        let spaceships = [];
        let tentacleAttacks = [];

        // Canvas setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Input handling
        let keys = {};
        let mobileControls = {
            left: false,
            right: false,
            shoot: false,
            aimDirection: { x: 0, y: -1 }
        };

        // Event Listeners
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            
            // CORRIGIDO: Pause com ESC
            if (e.key === 'Escape' && gameState.gameRunning && !gameState.cutsceneActive) {
                e.preventDefault();
                togglePause();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // CORRIGIDO: Clear keys when window loses focus to prevent stuck keys
        window.addEventListener('blur', () => {
            keys = {};
            mobileControls = {
                left: false,
                right: false,
                shoot: false,
                aimDirection: { x: 0, y: -1 }
            };
        });

        // CORRIGIDO: Detecta quando a tela fica vis√≠vel novamente
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && gameState.gameRunning && !gameState.paused) {
                togglePause(); // Auto-pause quando sai da aba
            }
        });

        // Setup shopkeeper canvas
        function drawShopkeeper() {
            const shopCanvas = document.getElementById('shopkeeperCanvas');
            const shopCtx = shopCanvas.getContext('2d');
            
            // Clear
            shopCtx.fillStyle = '#FFD700';
            shopCtx.fillRect(0, 0, 120, 120);
            
            // Shopkeeper (ball with hat)
            shopCtx.fillStyle = '#32CD32';
            shopCtx.beginPath();
            shopCtx.arc(60, 70, 25, 0, Math.PI * 2);
            shopCtx.fill();
            
            // Eyes
            shopCtx.fillStyle = '#000000';
            shopCtx.fillRect(50, 60, 6, 6);
            shopCtx.fillRect(64, 60, 6, 6);
            
            // Hat
            shopCtx.fillStyle = '#8B4513';
            shopCtx.fillRect(45, 35, 30, 20);
            shopCtx.fillRect(40, 50, 40, 5);
        }

        // Mobile controls setup
        function setupMobileControls() {
            // Game controls
            const gameControls = [
                { id: 'leftBtn', action: 'left' },
                { id: 'rightBtn', action: 'right' }
            ];
            
            gameControls.forEach(control => {
                const element = document.getElementById(control.id);
                element.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    mobileControls[control.action] = true;
                });
                element.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    mobileControls[control.action] = false;
                });
                element.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    mobileControls[control.action] = false;
                });
            });

            // Aim controls
            const aimControls = {
                aimUpLeft: { x: -1, y: -1 },
                aimUp: { x: 0, y: -1 },
                aimUpRight: { x: 1, y: -1 },
                aimLeft: { x: -1, y: 0 },
                aimRight: { x: 1, y: 0 }
            };

            Object.keys(aimControls).forEach(id => {
                document.getElementById(id).addEventListener('click', () => {
                    mobileControls.aimDirection = aimControls[id];
                    player.aimDirection = aimControls[id];
                });
            });

            // Shoot buttons
            document.getElementById('shoot').addEventListener('click', () => shoot());
            
            // Special ability buttons
            document.getElementById('shieldBtn').addEventListener('click', () => useShield());
            document.getElementById('laserBtn').addEventListener('click', () => useLaser());
            document.getElementById('swordBtn').addEventListener('click', () => useSwordRain());
        }

        // Menu navigation
        document.getElementById('playButton').addEventListener('click', () => {
            showScreen('levelSelect');
        });

        document.getElementById('shopButton').addEventListener('click', () => {
            showScreen('shop');
        });

        document.getElementById('achievementsButton').addEventListener('click', () => {
            showScreen('achievements');
        });

        document.getElementById('resetSaveButton').addEventListener('click', () => {
            resetSave();
        });

        document.getElementById('backToMenu').addEventListener('click', () => {
            showScreen('menu');
        });

        document.getElementById('backToMenuFromShop').addEventListener('click', () => {
            showScreen('menu');
        });

        document.getElementById('backToMenuFromAchievements').addEventListener('click', () => {
            showScreen('menu');
        });

        document.getElementById('goToWorld2').addEventListener('click', () => {
            showScreen('world2Select');
        });

        document.getElementById('backToWorld1').addEventListener('click', () => {
            showScreen('levelSelect');
        });

        document.getElementById('level1Button').addEventListener('click', () => {
            gameState.currentLevel = 1;
            gameState.currentWorld = 1;
            document.getElementById('levelTitle').textContent = 'FASE 1';
            document.getElementById('levelDesc').textContent = 'Em um lugar onde s√≥ existem bolas, algo triangular aparece...';
            showScreen('levelDescription');
        });

        document.getElementById('world2Level1Button').addEventListener('click', () => {
            gameState.currentLevel = 5;
            gameState.currentWorld = 2;
            document.getElementById('levelTitle').textContent = 'FASE 5';
            document.getElementById('levelDesc').textContent = 'Depois de atravessar a floresta, uma vila ao longe posso ver!';
            showScreen('levelDescription');
        });

        document.getElementById('backToLevels').addEventListener('click', () => {
            if (gameState.currentWorld === 1) {
                showScreen('levelSelect');
            } else {
                showScreen('world2Select');
            }
        });

        document.getElementById('enterLevel').addEventListener('click', () => {
            if (gameState.currentLevel === 1) {
                startLevel1();
            } else if (gameState.currentLevel === 2) {
                startLevel2();
            } else if (gameState.currentLevel === 3) {
                startLevel3();
            } else if (gameState.currentLevel === 4) {
                startLevel4();
            } else if (gameState.currentLevel === 5) {
                startWorld2Level1();
            } else if (gameState.currentLevel === 6) {
                startWorld2Level2();
            } else if (gameState.currentLevel === 7) {
                startWorld2Level3();
            } else if (gameState.currentLevel === 8) {
                startWorld2Level4();
            }
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            togglePause();
        });

        document.getElementById('resumeBtn').addEventListener('click', () => {
            togglePause();
        });

        document.getElementById('quitBtn').addEventListener('click', () => {
            quitGame();
        });

        document.getElementById('skipCutscene').addEventListener('click', () => {
            skipCutscene();
        });

        // Shop buttons
        document.getElementById('buyShield').addEventListener('click', () => {
            if (gameState.money >= 100 && !gameState.hasShield) {
                gameState.money -= 100;
                gameState.hasShield = true;
                updateMoneyDisplay();
                updateShopDisplay();
                saveGame();
                document.getElementById('shopkeeperText').textContent = '"Excelente escolha! Voc√™ estar√° protegido!"';
            } else if (gameState.hasShield) {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ j√° tem isso!"';
            } else {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ n√£o tem dinheiro suficiente!"';
            }
        });

        document.getElementById('buyExtraLife').addEventListener('click', () => {
            if (gameState.money >= 250 && !gameState.hasExtraLife) {
                gameState.money -= 250;
                gameState.hasExtraLife = true;
                player.maxHP = 150;
                player.hp = Math.min(player.hp + 50, 150);
                updateMoneyDisplay();
                updateShopDisplay();
                saveGame();
                document.getElementById('playerHP').textContent = player.hp;
                document.getElementById('playerMaxHP').textContent = player.maxHP;
                document.getElementById('shopkeeperText').textContent = '"Agora voc√™ est√° mais resistente!"';
            } else if (gameState.hasExtraLife) {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ j√° tem isso!"';
            } else {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ n√£o tem dinheiro suficiente!"';
            }
        });

        document.getElementById('buyShotUpgrade').addEventListener('click', () => {
            if (gameState.money >= 300 && !gameState.hasShotUpgrade) {
                gameState.money -= 300;
                gameState.hasShotUpgrade = true;
                updateMoneyDisplay();
                updateShopDisplay();
                saveGame();
                document.getElementById('shopkeeperText').textContent = '"Seus tiros agora s√£o mais poderosos!"';
            } else if (gameState.hasShotUpgrade) {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ j√° tem isso!"';
            } else {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ n√£o tem dinheiro suficiente!"';
            }
        });

        document.getElementById('buyLaser').addEventListener('click', () => {
            if (gameState.money >= 400 && !gameState.hasLaser) {
                gameState.money -= 400;
                gameState.hasLaser = true;
                updateMoneyDisplay();
                updateShopDisplay();
                saveGame();
                document.getElementById('shopkeeperText').textContent = '"Poder devastador! Use com sabedoria!"';
            } else if (gameState.hasLaser) {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ j√° tem isso!"';
            } else {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ n√£o tem dinheiro suficiente!"';
            }
        });

        document.getElementById('buyLifeUpgrade').addEventListener('click', () => {
            if (gameState.money >= 500 && !gameState.hasLifeUpgrade && gameState.hasExtraLife) {
                gameState.money -= 500;
                gameState.hasLifeUpgrade = true;
                player.maxHP = 200;
                player.hp = Math.min(player.hp + 50, 200);
                updateMoneyDisplay();
                updateShopDisplay();
                saveGame();
                document.getElementById('playerHP').textContent = player.hp;
                document.getElementById('playerMaxHP').textContent = player.maxHP;
                document.getElementById('shopkeeperText').textContent = '"Vida suprema! Voc√™ √© quase indestrut√≠vel!"';
            } else if (gameState.hasLifeUpgrade) {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ j√° tem isso!"';
            } else if (!gameState.hasExtraLife) {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ precisa comprar Vida Extra primeiro!"';
            } else {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ n√£o tem dinheiro suficiente!"';
            }
        });

        document.getElementById('buyShotMaster').addEventListener('click', () => {
            if (gameState.money >= 600 && !gameState.hasShotMaster && gameState.hasShotUpgrade) {
                gameState.money -= 600;
                gameState.hasShotMaster = true;
                updateMoneyDisplay();
                updateShopDisplay();
                saveGame();
                document.getElementById('shopkeeperText').textContent = '"Mestria no tiro! Seus inimigos tremer√£o!"';
            } else if (gameState.hasShotMaster) {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ j√° tem isso!"';
            } else if (!gameState.hasShotUpgrade) {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ precisa comprar Melhoria de Tiro primeiro!"';
            } else {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ n√£o tem dinheiro suficiente!"';
            }
        });

        document.getElementById('buySwordRain').addEventListener('click', () => {
            if (gameState.money >= 800 && !gameState.hasSwordRain) {
                gameState.money -= 800;
                gameState.hasSwordRain = true;
                updateMoneyDisplay();
                updateShopDisplay();
                saveGame();
                document.getElementById('shopkeeperText').textContent = '"Poder devastador dos portais! Use uma vez por fase!"';
            } else if (gameState.hasSwordRain) {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ j√° tem isso!"';
            } else {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ n√£o tem dinheiro suficiente!"';
            }
        });

        document.getElementById('buyLaserUpgrade').addEventListener('click', () => {
            if (gameState.money >= 1000 && !gameState.hasLaserUpgrade && gameState.hasLaser) {
                gameState.money -= 1000;
                gameState.hasLaserUpgrade = true;
                updateMoneyDisplay();
                updateShopDisplay();
                saveGame();
                document.getElementById('shopkeeperText').textContent = '"Laser supremo! Nada resiste a esse poder!"';
            } else if (gameState.hasLaserUpgrade) {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ j√° tem isso!"';
            } else if (!gameState.hasLaser) {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ precisa comprar Tiro Especial primeiro!"';
            } else {
                document.getElementById('shopkeeperText').textContent = '"Voc√™ n√£o tem dinheiro suficiente!"';
            }
        });

        // Screen management
        function showScreen(screen) {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('levelSelect').classList.add('hidden');
            document.getElementById('world2Select').classList.add('hidden');
            document.getElementById('levelDescription').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('shopScreen').classList.add('hidden');
            document.getElementById('achievementsScreen').classList.add('hidden');

            switch(screen) {
                case 'menu':
                    document.getElementById('mainMenu').classList.remove('hidden');
                    break;
                case 'levelSelect':
                    document.getElementById('levelSelect').classList.remove('hidden');
                    updateLevelSelect();
                    break;
                case 'world2Select':
                    document.getElementById('world2Select').classList.remove('hidden');
                    updateWorld2Select();
                    break;
                case 'levelDescription':
                    document.getElementById('levelDescription').classList.remove('hidden');
                    break;
                case 'game':
                    document.getElementById('gameScreen').classList.remove('hidden');
                    updateAbilityButtons();
                    break;
                case 'shop':
                    document.getElementById('shopScreen').classList.remove('hidden');
                    drawShopkeeper();
                    updateShopDisplay();
                    break;
                case 'achievements':
                    document.getElementById('achievementsScreen').classList.remove('hidden');
                    updateAchievementsScreen();
                    break;
            }
            
            gameState.screen = screen;
            updateMoneyDisplay();
        }

        function updateWorld2Select() {
            // Update level 2 unlock
            if (gameState.world2Level1Completed && !gameState.world2Level2Unlocked) {
                gameState.world2Level2Unlocked = true;
                const level2Container = document.getElementById('world2Level2Container');
                level2Container.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl mb-2">üèòÔ∏è</div>
                        <div class="text-white pixel-font text-xs mb-2">FASE 6</div>
                        <button id="world2Level2Button" class="game-button bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded pixel-font text-xs">
                            SELECIONAR
                        </button>
                    </div>
                `;
                level2Container.className = "level-item bg-white/20 p-4 rounded-lg border-2 border-white/30";
                
                document.getElementById('world2Level2Button').addEventListener('click', () => {
                    gameState.currentLevel = 6;
                    gameState.currentWorld = 2;
                    document.getElementById('levelTitle').textContent = 'FASE 6';
                    document.getElementById('levelDesc').textContent = 'Salve elas! Destrua as naves! (Naves dropam bolas 50% chance - Necess√°rio para pr√≥ximas fases)';
                    showScreen('levelDescription');
                });
            }

            // Update level 3 unlock (requires 4 balls)
            if (gameState.ballsSaved >= 4 && !gameState.world2Level3Unlocked) {
                gameState.world2Level3Unlocked = true;
                const level3Container = document.getElementById('world2Level3Container');
                level3Container.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl mb-2">üå™Ô∏è</div>
                        <div class="text-white pixel-font text-xs mb-2">FASE 7</div>
                        <button id="world2Level3Button" class="game-button bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded pixel-font text-xs">
                            SELECIONAR
                        </button>
                    </div>
                `;
                level3Container.className = "level-item bg-white/20 p-4 rounded-lg border-2 border-white/30";
                
                document.getElementById('world2Level3Button').addEventListener('click', () => {
                    gameState.currentLevel = 7;
                    gameState.currentWorld = 2;
                    document.getElementById('levelTitle').textContent = 'FASE 7';
                    document.getElementById('levelDesc').textContent = 'O Apocalipse Come√ßou!';
                    showScreen('levelDescription');
                });
            }

            // Update level 4 unlock (requires 10 balls and level 3 completed)
            if (gameState.ballsSaved >= 10 && gameState.world2Level3Completed && !gameState.world2Level4Unlocked) {
                gameState.world2Level4Unlocked = true;
                const level4Container = document.getElementById('world2Level4Container');
                level4Container.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl mb-2">üêç</div>
                        <div class="text-white pixel-font text-xs mb-2">FASE 8</div>
                        <button id="world2Level4Button" class="game-button bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded pixel-font text-xs">
                            SELECIONAR
                        </button>
                    </div>
                `;
                level4Container.className = "level-item bg-white/20 p-4 rounded-lg border-2 border-white/30";
                
                document.getElementById('world2Level4Button').addEventListener('click', () => {
                    gameState.currentLevel = 8;
                    gameState.currentWorld = 2;
                    document.getElementById('levelTitle').textContent = 'FASE 8';
                    document.getElementById('levelDesc').textContent = 'Uma criatura surge, Mate ela';
                    showScreen('levelDescription');
                });
            }

            updateBallsDisplay();
        }

        function updateLevelSelect() {
            if (gameState.level1Completed && !gameState.level2Unlocked) {
                gameState.level2Unlocked = true;
                const level2Container = document.getElementById('level2Container');
                level2Container.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl mb-2">üèòÔ∏è</div>
                        <div class="text-white pixel-font text-xs mb-2">FASE 2</div>
                        <button id="level2Button" class="game-button bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded pixel-font text-xs">
                            SELECIONAR
                        </button>
                    </div>
                `;
                level2Container.className = "level-item bg-white/20 p-4 rounded-lg border-2 border-white/30";
                
                document.getElementById('level2Button').addEventListener('click', () => {
                    gameState.currentLevel = 2;
                    gameState.currentWorld = 1;
                    document.getElementById('levelTitle').textContent = 'FASE 2';
                    document.getElementById('levelDesc').textContent = 'Depois de um tempo, Blue voltou com mais for√ßa!';
                    showScreen('levelDescription');
                });
            }

            if (gameState.level2Completed && !gameState.level3Unlocked) {
                gameState.level3Unlocked = true;
                const level3Container = document.getElementById('level3Container');
                level3Container.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl mb-2">üöÄ</div>
                        <div class="text-white pixel-font text-xs mb-2">FASE 3</div>
                        <button id="level3Button" class="game-button bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded pixel-font text-xs">
                            SELECIONAR
                        </button>
                    </div>
                `;
                level3Container.className = "level-item bg-white/20 p-4 rounded-lg border-2 border-white/30";
                
                document.getElementById('level3Button').addEventListener('click', () => {
                    gameState.currentLevel = 3;
                    gameState.currentWorld = 1;
                    document.getElementById('levelTitle').textContent = 'FASE 3';
                    document.getElementById('levelDesc').textContent = 'Eles precisam de ajuda! Deixa eu entrar!';
                    showScreen('levelDescription');
                });
            }

            if (gameState.level3Completed && !gameState.level4Unlocked) {
                gameState.level4Unlocked = true;
                const level4Container = document.getElementById('level4Container');
                level4Container.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl mb-2">üü©</div>
                        <div class="text-white pixel-font text-xs mb-2">FASE 4</div>
                        <button id="level4Button" class="game-button bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded pixel-font text-xs">
                            SELECIONAR
                        </button>
                    </div>
                `;
                level4Container.className = "level-item bg-white/20 p-4 rounded-lg border-2 border-white/30";
                
                document.getElementById('level4Button').addEventListener('click', () => {
                    gameState.currentLevel = 4;
                    gameState.currentWorld = 1;
                    document.getElementById('levelTitle').textContent = 'FASE 4';
                    document.getElementById('levelDesc').textContent = 'Um planeta quadrado? Vamos ver oque nos espera!';
                    showScreen('levelDescription');
                });
            }

            if (gameState.level4Completed && !gameState.world2Unlocked) {
                gameState.world2Unlocked = true;
                document.getElementById('world2Button').classList.remove('hidden');
            }
        }

        function updateMoneyDisplay() {
            document.getElementById('moneyDisplay').textContent = gameState.money;
            document.getElementById('moneyDisplay2').textContent = gameState.money;
            document.getElementById('moneyDisplay3').textContent = gameState.money;
            document.getElementById('gameMoneyDisplay').textContent = gameState.money;
            document.getElementById('shopMoneyDisplay').textContent = gameState.money;
        }

        function updateBallsDisplay() {
            document.getElementById('ballsDisplay').textContent = gameState.ballsSaved;
            document.getElementById('gameBallsDisplay').textContent = gameState.ballsSaved;
        }

        function updateShopDisplay() {
            if (gameState.hasShield) {
                document.getElementById('buyShield').classList.add('hidden');
                document.getElementById('shieldOwned').classList.remove('hidden');
            }
            if (gameState.hasExtraLife) {
                document.getElementById('buyExtraLife').classList.add('hidden');
                document.getElementById('extraLifeOwned').classList.remove('hidden');
            }
            if (gameState.hasShotUpgrade) {
                document.getElementById('buyShotUpgrade').classList.add('hidden');
                document.getElementById('shotUpgradeOwned').classList.remove('hidden');
            }
            if (gameState.hasLaser) {
                document.getElementById('buyLaser').classList.add('hidden');
                document.getElementById('laserOwned').classList.remove('hidden');
            }
            if (gameState.hasLifeUpgrade) {
                document.getElementById('buyLifeUpgrade').classList.add('hidden');
                document.getElementById('lifeUpgradeOwned').classList.remove('hidden');
            }
            if (gameState.hasShotMaster) {
                document.getElementById('buyShotMaster').classList.add('hidden');
                document.getElementById('shotMasterOwned').classList.remove('hidden');
            }
            if (gameState.hasSwordRain) {
                document.getElementById('buySwordRain').classList.add('hidden');
                document.getElementById('swordRainOwned').classList.remove('hidden');
            }
            if (gameState.hasLaserUpgrade) {
                document.getElementById('buyLaserUpgrade').classList.add('hidden');
                document.getElementById('laserUpgradeOwned').classList.remove('hidden');
            }
        }

        function updateAbilityButtons() {
            const shieldBtn = document.getElementById('shieldBtn');
            const laserBtn = document.getElementById('laserBtn');
            const swordBtn = document.getElementById('swordBtn');
            
            if (gameState.hasShield) {
                shieldBtn.classList.remove('hidden');
            }
            if (gameState.hasLaser) {
                laserBtn.classList.remove('hidden');
            }
            if (gameState.hasSwordRain) {
                swordBtn.classList.remove('hidden');
            }
        }

        function addFloatingText(x, y, text, color = '#00FF00') {
            floatingTexts.push({
                x: x,
                y: y,
                text: text,
                color: color,
                opacity: 1,
                startTime: Date.now()
            });
        }

        // Ability functions
        function useShield() {
            if (gameState.hasShield && gameState.shieldCooldown <= 0 && !gameState.shieldActive) {
                gameState.shieldActive = true;
                gameState.shieldDuration = 5000; // 5 seconds in milliseconds
                gameState.shieldCooldown = 25000; // 25 seconds cooldown
                createParticles(player.x + player.width/2, player.y + player.height/2, '#00AAFF', 12);
            }
        }

        function useLaser() {
            if (gameState.hasLaser && gameState.totalDamageDealt >= 20) {
                const laserDamage = gameState.hasLaserUpgrade ? 100 : 50;
                
                // Create laser
                lasers.push({
                    x: player.x + player.width/2,
                    y: 0,
                    width: 50,
                    height: canvas.height,
                    duration: 500,
                    startTime: Date.now(),
                    damaged: false,
                    damage: laserDamage
                });
                
                // Reset damage requirement
                gameState.totalDamageDealt = 0;
                document.getElementById('gameDamageDisplay').textContent = gameState.totalDamageDealt;
                
                createParticles(player.x + player.width/2, 0, '#00AAFF', 20);
            }
        }

        function useSwordRain() {
            if (gameState.hasSwordRain && gameState.swordRainUsesLeft > 0) {
                gameState.swordRainUsesLeft--;
                document.getElementById('swordUses').textContent = gameState.swordRainUsesLeft;
                
                // Finger snap effect
                fingerSnapEffect = {
                    x: player.x + player.width/2,
                    y: player.y + player.height/2,
                    startTime: Date.now(),
                    duration: 300
                };
                
                createParticles(player.x + player.width/2, player.y + player.height/2, '#FF0000', 15);
                
                // Create portals and swords after a small delay
                setTimeout(() => {
                    createSwordRain();
                }, 200);
            }
        }

        function createSwordRain() {
            // Create 15 portals spread across the top of the screen
            for (let i = 0; i < 15; i++) {
                // Random position across the entire top area of the screen
                const portalX = Math.random() * (canvas.width - 100) + 50;
                const portalY = Math.random() * 150 + 50;
                
                portals.push({
                    x: portalX,
                    y: portalY,
                    startTime: Date.now() + i * 50,
                    duration: 1000
                });
                
                // Create sword after portal appears
                setTimeout(() => {
                    swords.push({
                        x: portalX,
                        y: portalY - 30,
                        speed: 8,
                        damage: 10,
                        hit: false
                    });
                }, i * 50 + 300);
            }
        }

        // Game functions
        function startLevel1() {
            showScreen('game');
            resetGame();
            startCutscene1();
        }

        function startLevel2() {
            showScreen('game');
            resetGame();
            gameTime = 50;
            startCutscene2();
        }

        function startLevel3() {
            showScreen('game');
            resetGame();
            startCutscene3();
        }

        function startLevel4() {
            showScreen('game');
            resetGame();
            gameTime = 60;
            enemySpawnPaused = false;
            startCutscene4();
        }

        // New World 2 Level Functions
        function startWorld2Level1() {
            showScreen('game');
            resetGame();
            gameTime = 45;
            startWorld2Level1Cutscene();
        }

        function startWorld2Level2() {
            showScreen('game');
            resetGame();
            gameTime = 120; // 2 minutos para farmar bolas
            startWorld2Level2Cutscene();
        }

        function startWorld2Level3() {
            showScreen('game');
            resetGame();
            gameTime = 50;
            startWorld2Level3Cutscene();
        }

        function startWorld2Level4() {
            showScreen('game');
            resetGame();
            startWorld2Level4Cutscene();
        }

        function resetGame() {
            player.x = 400;
            player.y = 500;
            
            // Set HP based on upgrades
            if (gameState.hasLifeUpgrade) {
                player.hp = 200;
                player.maxHP = 200;
            } else if (gameState.hasExtraLife) {
                player.hp = 150;
                player.maxHP = 150;
            } else {
                player.hp = 100;
                player.maxHP = 100;
            }
            
            bullets = [];
            enemies = [];
            lasers = [];
            bombs = [];
            boss = null;
            gameTime = 30;
            lastEnemySpawn = 0;
            lastBigEnemySpawn = 0;
            lastRollingEnemySpawn = 0;
            floatingTexts = [];
            particles = [];
            gameState.gameRunning = false;
            gameState.paused = false;
            gameState.shieldActive = false;
            gameState.shieldDuration = 0;
            gameState.totalDamageDealt = 0;
            gameState.vineTrapped = false;
            gameState.vineTrapDuration = 0;
            enemySpawnPaused = false;
            swords = [];
            portals = [];
            fingerSnapEffect = null;
            vines = [];
            spaceships = [];
            tentacleAttacks = [];
            
            // Reset sword rain uses
            if (gameState.hasSwordRain) {
                gameState.swordRainUsesLeft = 1;
                document.getElementById('swordUsesContainer').classList.remove('hidden');
                document.getElementById('swordUses').textContent = gameState.swordRainUsesLeft;
            } else {
                document.getElementById('swordUsesContainer').classList.add('hidden');
            }
            
            // Show balls container for World 2
            if (gameState.currentWorld === 2) {
                document.getElementById('ballsContainer').classList.remove('hidden');
                updateBallsDisplay();
            } else {
                document.getElementById('ballsContainer').classList.add('hidden');
            }
            
            // Reset mobile controls to prevent auto-movement
            mobileControls = {
                left: false,
                right: false,
                shoot: false,
                aimDirection: { x: 0, y: -1 }
            };
            
            // Clear any stuck keys
            keys = {};
            
            // Reset enemy bullets
            window.enemyBullets = [];
            
            // Hide boss health bar and warnings
            document.getElementById('bossHealthBar').classList.add('hidden');
            document.getElementById('bossWarning').classList.add('hidden');
            document.getElementById('tentacleWarning').classList.add('hidden');
            document.getElementById('segmentInfo').classList.add('hidden');
            
            // Show/hide time display based on level
            if (gameState.currentLevel === 3 || gameState.currentLevel === 8) {
                document.getElementById('gameTimeContainer').style.display = 'none';
            } else {
                document.getElementById('gameTimeContainer').style.display = 'block';
            }

            // Update HP display
            document.getElementById('playerHP').textContent = player.hp;
            document.getElementById('playerMaxHP').textContent = player.maxHP;
        }

        // World 2 Cutscenes
        function startWorld2Level1Cutscene() {
            gameState.cutsceneActive = true;
            document.getElementById('cutsceneOverlay').classList.remove('hidden');
            
            let cutsceneCanvas = document.createElement('canvas');
            cutsceneCanvas.width = 400;
            cutsceneCanvas.height = 300;
            cutsceneCanvas.style.border = '2px solid white';
            cutsceneCanvas.style.borderRadius = '8px';
            
            const cutsceneCtx = cutsceneCanvas.getContext('2d');
            
            // Square forest background
            cutsceneCtx.fillStyle = '#228B22';
            cutsceneCtx.fillRect(0, 0, 400, 300);
            
            // Square trees
            cutsceneCtx.fillStyle = '#8B4513';
            for (let i = 0; i < 6; i++) {
                const x = 30 + i * 60;
                cutsceneCtx.fillRect(x, 180, 25, 70);
            }
            
            // Square leaves
            cutsceneCtx.fillStyle = '#32CD32';
            for (let i = 0; i < 6; i++) {
                const x = 20 + i * 60;
                cutsceneCtx.fillRect(x, 150, 45, 45);
            }
            
            // Player moving through forest
            cutsceneCtx.fillStyle = '#32CD32';
            cutsceneCtx.beginPath();
            cutsceneCtx.arc(120, 220, 12, 0, Math.PI * 2);
            cutsceneCtx.fill();
            
            // Village in distance
            cutsceneCtx.fillStyle = '#8B4513';
            cutsceneCtx.fillRect(300, 100, 80, 60);
            cutsceneCtx.fillRect(320, 80, 40, 20);
            
            const contentDiv = document.getElementById('cutsceneContent');
            contentDiv.innerHTML = '';
            contentDiv.appendChild(cutsceneCanvas);
            
            const textDiv = document.createElement('div');
            textDiv.textContent = 'Atravessando a floresta quadrada... "Uma vila! Finalmente!"';
            textDiv.className = 'text-white pixel-font text-sm text-center mt-4';
            contentDiv.appendChild(textDiv);
            
            setTimeout(() => {
                endCutscene();
            }, 3000);
        }

        function startWorld2Level2Cutscene() {
            gameState.cutsceneActive = true;
            document.getElementById('cutsceneOverlay').classList.remove('hidden');
            
            let cutsceneCanvas = document.createElement('canvas');
            cutsceneCanvas.width = 400;
            cutsceneCanvas.height = 300;
            cutsceneCanvas.style.border = '2px solid white';
            cutsceneCanvas.style.borderRadius = '8px';
            
            const cutsceneCtx = cutsceneCanvas.getContext('2d');
            
            // Square village background
            cutsceneCtx.fillStyle = '#8FBC8F';
            cutsceneCtx.fillRect(0, 0, 400, 300);
            
            // Village buildings
            cutsceneCtx.fillStyle = '#8B4513';
            cutsceneCtx.fillRect(50, 150, 80, 100);
            cutsceneCtx.fillRect(180, 140, 90, 110);
            cutsceneCtx.fillRect(320, 160, 70, 90);
            
            // Roofs
            cutsceneCtx.fillStyle = '#B22222';
            cutsceneCtx.fillRect(45, 130, 90, 20);
            cutsceneCtx.fillRect(175, 120, 100, 20);
            cutsceneCtx.fillRect(315, 140, 80, 20);
            
            // Spaceships attacking
            cutsceneCtx.fillStyle = '#666666';
            cutsceneCtx.fillRect(100, 50, 60, 30);
            cutsceneCtx.fillRect(250, 40, 60, 30);
            
            // Laser beams
            cutsceneCtx.fillStyle = '#FF0000';
            cutsceneCtx.fillRect(125, 80, 10, 50);
            cutsceneCtx.fillRect(275, 70, 10, 60);
            
            const contentDiv = document.getElementById('cutsceneContent');
            contentDiv.innerHTML = '';
            contentDiv.appendChild(cutsceneCanvas);
            
            const textDiv = document.createElement('div');
            textDiv.textContent = '"As naves est√£o atacando a vila! Preciso destru√≠-las e salvar as bolas!"';
            textDiv.className = 'text-white pixel-font text-sm text-center mt-4';
            contentDiv.appendChild(textDiv);
            
            setTimeout(() => {
                endCutscene();
            }, 3000);
        }

        function startWorld2Level3Cutscene() {
            gameState.cutsceneActive = true;
            document.getElementById('cutsceneOverlay').classList.remove('hidden');
            
            let cutsceneCanvas = document.createElement('canvas');
            cutsceneCanvas.width = 400;
            cutsceneCanvas.height = 300;
            cutsceneCanvas.style.border = '2px solid white';
            cutsceneCanvas.style.borderRadius = '8px';
            
            const cutsceneCtx = cutsceneCanvas.getContext('2d');
            
            // Village being invaded
            cutsceneCtx.fillStyle = '#8FBC8F';
            cutsceneCtx.fillRect(0, 0, 400, 300);
            
            // Blue's ship
            cutsceneCtx.fillStyle = '#666666';
            cutsceneCtx.fillRect(150, 30, 100, 40);
            cutsceneCtx.fillRect(175, 10, 50, 20);
            
            // Sound wave effect
            cutsceneCtx.strokeStyle = '#00FFFF';
            cutsceneCtx.lineWidth = 3;
            for (let i = 0; i < 5; i++) {
                cutsceneCtx.beginPath();
                cutsceneCtx.arc(200, 70, 50 + i * 20, 0, Math.PI);
                cutsceneCtx.stroke();
            }
            
            // Tentacles emerging
            cutsceneCtx.fillStyle = '#228B22';
            for (let i = 0; i < 6; i++) {
                const x = 50 + i * 60;
                cutsceneCtx.fillRect(x, 200, 15, 100);
                cutsceneCtx.fillRect(x - 5, 190, 25, 15);
            }
            
            const contentDiv = document.getElementById('cutsceneContent');
            contentDiv.innerHTML = '';
            contentDiv.appendChild(cutsceneCanvas);
            
            const textDiv = document.createElement('div');
            textDiv.textContent = 'Blue emite uma onda sonora! Os ret√¢ngulos-planta despertam! "O apocalipse come√ßou!"';
            textDiv.className = 'text-white pixel-font text-sm text-center mt-4';
            contentDiv.appendChild(textDiv);
            
            setTimeout(() => {
                endCutscene();
            }, 4000);
        }

        function startWorld2Level4Cutscene() {
            gameState.cutsceneActive = true;
            document.getElementById('cutsceneOverlay').classList.remove('hidden');
            
            let cutsceneCanvas = document.createElement('canvas');
            cutsceneCanvas.width = 400;
            cutsceneCanvas.height = 300;
            cutsceneCanvas.style.border = '2px solid white';
            cutsceneCanvas.style.borderRadius = '8px';
            
            const cutsceneCtx = cutsceneCanvas.getContext('2d');
            
            // Consumed village
            cutsceneCtx.fillStyle = '#2F4F2F';
            cutsceneCtx.fillRect(0, 0, 400, 300);
            
            // Tentacles everywhere
            cutsceneCtx.fillStyle = '#228B22';
            for (let i = 0; i < 10; i++) {
                const x = Math.random() * 380;
                const y = Math.random() * 280;
                cutsceneCtx.fillRect(x, y, 20, Math.random() * 100 + 50);
            }
            
            // Snake boss emerging
            cutsceneCtx.fillStyle = '#32CD32';
            // Snake body segments
            for (let i = 0; i < 8; i++) {
                const x = 100 + i * 30;
                const y = 150 + Math.sin(i * 0.5) * 30;
                cutsceneCtx.fillRect(x, y, 25, 25);
            }
            
            // Snake head
            cutsceneCtx.fillStyle = '#228B22';
            cutsceneCtx.fillRect(320, 120, 35, 35);
            
            // Red eyes
            cutsceneCtx.fillStyle = '#FF0000';
            cutsceneCtx.fillRect(325, 125, 8, 8);
            cutsceneCtx.fillRect(337, 125, 8, 8);
            
            const contentDiv = document.getElementById('cutsceneContent');
            contentDiv.innerHTML = '';
            contentDiv.appendChild(cutsceneCanvas);
            
            const textDiv = document.createElement('div');
            textDiv.textContent = 'Uma criatura gigantesca emerge dos tent√°culos! A Cobra dos Quadrados desperta!';
            textDiv.className = 'text-white pixel-font text-sm text-center mt-4';
            contentDiv.appendChild(textDiv);
            
            setTimeout(() => {
                endCutscene();
            }, 4000);
        }

        function startCutscene4() {
            gameState.cutsceneActive = true;
            document.getElementById('cutsceneOverlay').classList.remove('hidden');
            
            let cutsceneCanvas = document.createElement('canvas');
            cutsceneCanvas.width = 400;
            cutsceneCanvas.height = 300;
            cutsceneCanvas.style.border = '2px solid white';
            cutsceneCanvas.style.borderRadius = '8px';
            
            const cutsceneCtx = cutsceneCanvas.getContext('2d');
            
            // Square planet background
            cutsceneCtx.fillStyle = '#228B22';
            cutsceneCtx.fillRect(0, 0, 400, 300);
            
            // Square trees
            cutsceneCtx.fillStyle = '#8B4513';
            cutsceneCtx.fillRect(50, 150, 30, 80);
            cutsceneCtx.fillRect(120, 140, 25, 90);
            cutsceneCtx.fillRect(200, 160, 35, 70);
            cutsceneCtx.fillRect(280, 145, 28, 85);
            cutsceneCtx.fillRect(350, 155, 32, 75);
            
            // Square leaves
            cutsceneCtx.fillStyle = '#32CD32';
            cutsceneCtx.fillRect(40, 120, 50, 50);
            cutsceneCtx.fillRect(110, 110, 45, 45);
            cutsceneCtx.fillRect(185, 130, 65, 50);
            cutsceneCtx.fillRect(270, 115, 48, 48);
            cutsceneCtx.fillRect(335, 125, 62, 50);
            
            // Space ship landing
            cutsceneCtx.fillStyle = '#808080';
            cutsceneCtx.fillRect(180, 80, 40, 20);
            cutsceneCtx.fillRect(190, 60, 20, 20);
            
            // Ship details
            cutsceneCtx.fillStyle = '#FF0000';
            cutsceneCtx.fillRect(185, 90, 5, 5);
            cutsceneCtx.fillRect(195, 90, 5, 5);
            cutsceneCtx.fillRect(205, 90, 5, 5);
            
            // Player getting out
            cutsceneCtx.fillStyle = '#32CD32';
            cutsceneCtx.beginPath();
            cutsceneCtx.arc(160, 110, 10, 0, Math.PI * 2);
            cutsceneCtx.fill();
            
            const contentDiv = document.getElementById('cutsceneContent');
            contentDiv.innerHTML = '';
            contentDiv.appendChild(cutsceneCanvas);
            
            const textDiv = document.createElement('div');
            textDiv.textContent = 'A nave chega ao planeta quadrado... "Onde voc√™s est√£o em?"';
            textDiv.className = 'text-white pixel-font text-sm text-center mt-4';
            contentDiv.appendChild(textDiv);
            
            setTimeout(() => {
                endCutscene();
            }, 3000);
        }

        function startCutscene3() {
            gameState.cutsceneActive = true;
            document.getElementById('cutsceneOverlay').classList.remove('hidden');
            
            let cutsceneStep = 0;
            let cutsceneCanvas = document.createElement('canvas');
            cutsceneCanvas.width = 400;
            cutsceneCanvas.height = 300;
            cutsceneCanvas.style.border = '2px solid white';
            cutsceneCanvas.style.borderRadius = '8px';
            
            const cutsceneCtx = cutsceneCanvas.getContext('2d');
            
            function renderCutscene3() {
                // Background
                cutsceneCtx.fillStyle = '#FFB6C1';
                cutsceneCtx.fillRect(0, 0, 400, 300);
                
                // Planet machine
                cutsceneCtx.fillStyle = '#C0C0C0';
                cutsceneCtx.fillRect(150, 80, 100, 120);
                cutsceneCtx.fillRect(175, 60, 50, 20);
                
                // Machine details
                cutsceneCtx.fillStyle = '#0080FF';
                cutsceneCtx.fillRect(170, 100, 60, 10);
                cutsceneCtx.fillRect(170, 120, 60, 10);
                cutsceneCtx.fillRect(170, 140, 60, 10);
                
                // Portal effect
                cutsceneCtx.fillStyle = '#8A2BE2';
                cutsceneCtx.beginPath();
                cutsceneCtx.arc(200, 160, 20, 0, Math.PI * 2);
                cutsceneCtx.fill();
                
                if (cutsceneStep >= 1) {
                    // Player approaching
                    cutsceneCtx.fillStyle = '#32CD32';
                    cutsceneCtx.beginPath();
                    cutsceneCtx.arc(80, 180, 15, 0, Math.PI * 2);
                    cutsceneCtx.fill();
                    
                    cutsceneCtx.fillStyle = '#00FF00';
                    cutsceneCtx.fillRect(73, 173, 5, 5);
                    cutsceneCtx.fillRect(82, 173, 5, 5);
                }
                
                if (cutsceneStep >= 2) {
                    // Boss ball (red with green eyes)
                    cutsceneCtx.fillStyle = '#FF0000';
                    cutsceneCtx.beginPath();
                    cutsceneCtx.arc(320, 180, 25, 0, Math.PI * 2);
                    cutsceneCtx.fill();
                    
                    cutsceneCtx.fillStyle = '#00FF00';
                    cutsceneCtx.fillRect(310, 170, 8, 8);
                    cutsceneCtx.fillRect(322, 170, 8, 8);
                }
            }
            
            const cutsceneTexts = [
                "O jogador chega a uma m√°quina de viagem entre planetas...",
                '"Por favor, preciso usar a m√°quina para resgatar as bolas!"',
                '"N√ÉO! Esta m√°quina √© nossa!" - Bola Dona aparece',
                '"Ent√£o ser√° por bem ou por mal!" - A batalha come√ßa!'
            ];
            
            function showCutsceneStep() {
                if (cutsceneStep < cutsceneTexts.length) {
                    renderCutscene3();
                    
                    const contentDiv = document.getElementById('cutsceneContent');
                    contentDiv.innerHTML = '';
                    contentDiv.appendChild(cutsceneCanvas);
                    
                    const textDiv = document.createElement('div');
                    textDiv.textContent = cutsceneTexts[cutsceneStep];
                    textDiv.className = 'text-white pixel-font text-sm text-center mt-4';
                    contentDiv.appendChild(textDiv);
                    
                    cutsceneStep++;
                    setTimeout(showCutsceneStep, 3000);
                } else {
                    endCutscene();
                }
            }
            
            showCutsceneStep();
        }

        function startCutscene1() {
            gameState.cutsceneActive = true;
            document.getElementById('cutsceneOverlay').classList.remove('hidden');
            
            let cutsceneStep = 0;
            let cutsceneCanvas = document.createElement('canvas');
            cutsceneCanvas.width = 400;
            cutsceneCanvas.height = 300;
            cutsceneCanvas.style.border = '2px solid white';
            cutsceneCanvas.style.borderRadius = '8px';
            
            const cutsceneCtx = cutsceneCanvas.getContext('2d');
            
            function renderCutscene() {
                cutsceneCtx.fillStyle = '#87CEEB';
                cutsceneCtx.fillRect(0, 0, 400, 300);
                
                cutsceneCtx.fillStyle = '#FFB6C1';
                for (let i = 0; i < 15; i++) {
                    const x = (i * 50) % 400;
                    const y = (i * 30) % 300;
                    cutsceneCtx.beginPath();
                    cutsceneCtx.arc(x, y, 8 + (i % 3), 0, Math.PI * 2);
                    cutsceneCtx.fill();
                }
                
                if (cutsceneStep >= 1) {
                    cutsceneCtx.fillStyle = '#808080';
                    cutsceneCtx.fillRect(150, 50, 100, 40);
                    cutsceneCtx.fillRect(175, 30, 50, 20);
                    
                    cutsceneCtx.fillStyle = '#FF0000';
                    cutsceneCtx.fillRect(160, 60, 10, 10);
                    cutsceneCtx.fillRect(180, 60, 10, 10);
                    cutsceneCtx.fillRect(200, 60, 10, 10);
                    cutsceneCtx.fillRect(220, 60, 10, 10);
                }
                
                if (cutsceneStep >= 3) {
                    cutsceneCtx.fillStyle = '#0066CC';
                    cutsceneCtx.fillRect(185, 100, 30, 30);
                    
                    cutsceneCtx.fillStyle = '#FF0000';
                    cutsceneCtx.fillRect(190, 105, 8, 8);
                    cutsceneCtx.fillRect(202, 105, 8, 8);
                    
                    cutsceneCtx.fillStyle = '#FFD700';
                    cutsceneCtx.fillRect(190, 100, 20, 5);
                }
            }
            
            const cutsceneTexts = [
                "Uma nave espacial aparece no horizonte...",
                "A nave pousa em meio √†s bolas do planeta.",
                "Um quadrado azul especial sai da nave...",
                '"Bolas? Interessante, quero pra mim!" - Blue',
                "A invas√£o come√ßou!"
            ];
            
            function showCutsceneStep() {
                if (cutsceneStep < cutsceneTexts.length) {
                    renderCutscene();
                    
                    const contentDiv = document.getElementById('cutsceneContent');
                    contentDiv.innerHTML = '';
                    contentDiv.appendChild(cutsceneCanvas);
                    
                    const textDiv = document.createElement('div');
                    textDiv.textContent = cutsceneTexts[cutsceneStep];
                    textDiv.className = 'text-white pixel-font text-sm text-center mt-4';
                    contentDiv.appendChild(textDiv);
                    
                    cutsceneStep++;
                    setTimeout(showCutsceneStep, 2500);
                } else {
                    endCutscene();
                }
            }
            
            showCutsceneStep();
        }

        function startCutscene2() {
            gameState.cutsceneActive = true;
            document.getElementById('cutsceneOverlay').classList.remove('hidden');
            
            let cutsceneCanvas = document.createElement('canvas');
            cutsceneCanvas.width = 400;
            cutsceneCanvas.height = 300;
            cutsceneCanvas.style.border = '2px solid white';
            cutsceneCanvas.style.borderRadius = '8px';
            
            const cutsceneCtx = cutsceneCanvas.getContext('2d');
            
            cutsceneCtx.fillStyle = '#333333';
            cutsceneCtx.fillRect(0, 0, 400, 300);
            
            cutsceneCtx.fillStyle = '#666666';
            cutsceneCtx.fillRect(50, 200, 300, 80);
            
            cutsceneCtx.fillStyle = '#87CEEB';
            cutsceneCtx.fillRect(150, 50, 100, 80);
            
            cutsceneCtx.fillStyle = '#8B4513';
            cutsceneCtx.fillRect(160, 100, 15, 15);
            cutsceneCtx.fillRect(175, 105, 10, 10);
            cutsceneCtx.fillRect(185, 95, 20, 20);
            
            cutsceneCtx.fillStyle = '#FFB6C1';
            cutsceneCtx.beginPath();
            cutsceneCtx.arc(165, 118, 3, 0, Math.PI * 2);
            cutsceneCtx.fill();
            cutsceneCtx.beginPath();
            cutsceneCtx.arc(190, 120, 3, 0, Math.PI * 2);
            cutsceneCtx.fill();
            
            cutsceneCtx.fillStyle = '#0066CC';
            cutsceneCtx.fillRect(80, 140, 30, 30);
            cutsceneCtx.fillStyle = '#FF0000';
            cutsceneCtx.fillRect(85, 145, 8, 8);
            cutsceneCtx.fillRect(97, 145, 8, 8);
            cutsceneCtx.fillStyle = '#FFD700';
            cutsceneCtx.fillRect(85, 140, 20, 5);
            
            const contentDiv = document.getElementById('cutsceneContent');
            contentDiv.innerHTML = '';
            contentDiv.appendChild(cutsceneCanvas);
            
            const textDiv = document.createElement('div');
            textDiv.textContent = '"Ali, PERFEITO!" - Blue observa uma vila no planeta';
            textDiv.className = 'text-white pixel-font text-sm text-center mt-4';
            contentDiv.appendChild(textDiv);
            
            setTimeout(() => {
                endCutscene();
            }, 3000);
        }

        function skipCutscene() {
            endCutscene();
        }

        function endCutscene() {
            gameState.cutsceneActive = false;
            document.getElementById('cutsceneOverlay').classList.add('hidden');
            startGameplay();
        }

        function startGameplay() {
            gameState.gameRunning = true;
            
            if (gameState.currentLevel === 3 || gameState.currentLevel === 8) {
                // Boss levels - no timer, spawn boss
                if (gameState.currentLevel === 3) {
                    spawnBoss();
                } else if (gameState.currentLevel === 8) {
                    spawnSnakeBoss();
                }
                document.getElementById('bossHealthBar').classList.remove('hidden');
                
                // NOVO: Mostrar info de segmentos para cobra
                if (gameState.currentLevel === 8) {
                    document.getElementById('segmentInfo').classList.remove('hidden');
                    updateSegmentInfo();
                }
            } else {
                document.getElementById('gameTime').textContent = gameTime;
            }
            
            document.getElementById('gameDamageDisplay').textContent = gameState.totalDamageDealt;
            gameLoop();
            
            if (gameState.currentLevel !== 3 && gameState.currentLevel !== 8) {
                const gameTimer = setInterval(() => {
                    if (!gameState.paused && gameState.gameRunning && !gameState.cutsceneActive) {
                        gameTime--;
                        document.getElementById('gameTime').textContent = gameTime;
                        
                        // Update ability timers
                        if (gameState.shieldCooldown > 0) {
                            gameState.shieldCooldown -= 1000;
                        }
                        
                        if (gameTime <= 0) {
                            clearInterval(gameTimer);
                        }
                    }
                    
                    // CORRIGIDO: Limpar timer quando jogo termina
                    if (!gameState.gameRunning) {
                        clearInterval(gameTimer);
                    }
                }, 1000);
            } else {
                // For boss levels, still need shield cooldown timer
                const abilityTimer = setInterval(() => {
                    if (!gameState.paused && gameState.gameRunning && !gameState.cutsceneActive) {
                        if (gameState.shieldCooldown > 0) {
                            gameState.shieldCooldown -= 1000;
                        }
                    }
                    if (!gameState.gameRunning) {
                        clearInterval(abilityTimer);
                    }
                }, 1000);
            }
        }

        // NOVO: Boss Cobra ULTRA DIF√çCIL com sistema de segmentos
        function spawnSnakeBoss() {
            boss = {
                x: canvas.width / 2,
                y: 200,
                hp: 350, // ULTRA DIF√çCIL: 350 HP!
                maxHP: 350,
                width: 300,
                height: 50,
                lastAttack: 0,
                attackPattern: 0,
                phase: 1,
                segments: [],
                type: 'snake_boss',
                arenaCreated: false,
                biteWarning: false,
                biteWarningStartTime: 0,
                segmentsDestroyed: 0,
                headVulnerable: false
            };
            
            // Create snake segments - each segment has HP
            for (let i = 0; i < 8; i++) {
                boss.segments.push({
                    x: boss.x - i * 35,
                    y: boss.y + Math.sin(i * 0.5) * 20,
                    baseY: boss.y,
                    hp: i === 7 ? 100 : 50, // Head has more HP
                    maxHP: i === 7 ? 100 : 50,
                    destroyed: false,
                    isHead: i === 7
                });
            }
            
            updateBossHealthBar();
            updateSegmentInfo();
            document.getElementById('bossName').textContent = 'COBRA DOS QUADRADOS';
        }

        // NOVO: Atualizar informa√ß√µes dos segmentos
        function updateSegmentInfo() {
            if (boss && boss.type === 'snake_boss') {
                const destroyedCount = boss.segments.filter(seg => seg.destroyed && !seg.isHead).length;
                document.getElementById('segmentCount').textContent = `${destroyedCount}/7`;
                
                if (destroyedCount >= 7) {
                    boss.headVulnerable = true;
                    document.getElementById('headStatus').textContent = 'VULNER√ÅVEL!';
                    document.getElementById('headStatus').style.color = '#ff0000';
                } else {
                    document.getElementById('headStatus').textContent = 'Protegida';
                    document.getElementById('headStatus').style.color = '#ffffff';
                }
            }
        }

        function spawnBoss() {
            boss = {
                x: canvas.width / 2,
                y: 150,
                hp: 40,
                maxHP: 40,
                width: 50,
                height: 50,
                lastAttack: 0,
                attackPattern: 0,
                isSlam: false,
                slamStartY: 0,
                slamSpeed: 0,
                phase: 1,
                slamWarning: false,
                warningStartTime: 0,
                type: 'ball_boss'
            };
            
            updateBossHealthBar();
        }

        function updateBossHealthBar() {
            if (boss) {
                const healthPercent = (boss.hp / boss.maxHP) * 100;
                document.getElementById('bossHealth').style.width = healthPercent + '%';
                
                if (boss.type === 'ball_boss') {
                    // Change boss name based on health
                    if (boss.hp <= boss.maxHP * 0.3) {
                        document.getElementById('bossName').textContent = 'BOLA DONA FURIOSA';
                    } else if (boss.hp <= boss.maxHP * 0.6) {
                        document.getElementById('bossName').textContent = 'BOLA DONA IRRITADA';
                    } else {
                        document.getElementById('bossName').textContent = 'BOLA DONA';
                    }
                } else if (boss.type === 'snake_boss') {
                    if (boss.hp <= boss.maxHP * 0.3) {
                        document.getElementById('bossName').textContent = 'COBRA FURIOSA';
                    } else if (boss.hp <= boss.maxHP * 0.6) {
                        document.getElementById('bossName').textContent = 'COBRA IRRITADA';
                    } else {
                        document.getElementById('bossName').textContent = 'COBRA DOS QUADRADOS';
                    }
                }
            }
        }

        function gameLoop() {
            if (!gameState.gameRunning) return;
            
            if (!gameState.paused && !gameState.cutsceneActive) {
                update();
                render();
            }
            
            requestAnimationFrame(gameLoop);
        }

        function update() {
            // Update part√≠culas
            updateParticles();

            // Vine trap handling
            if (gameState.vineTrapped) {
                if (gameState.vineTrapDuration > 0) {
                    gameState.vineTrapDuration -= 16; // ~60fps
                    // Player can't move or shoot while trapped
                    return;
                } else {
                    gameState.vineTrapped = false;
                    player.classList?.remove('vine-trapped');
                }
            }

            // Player movement
            if (keys['a'] || keys['ArrowLeft'] || mobileControls.left) {
                player.x = Math.max(0, player.x - player.speed);
            }
            if (keys['d'] || keys['ArrowRight'] || mobileControls.right) {
                player.x = Math.min(canvas.width - player.width, player.x + player.speed);
            }

            // Aim direction
            if (keys['w'] || keys['ArrowUp']) player.aimDirection = { x: 0, y: -1 };
            if (keys['q']) player.aimDirection = { x: -1, y: -1 };
            if (keys['e']) player.aimDirection = { x: 1, y: -1 };
            if (keys['a'] && (keys['w'] || keys['ArrowUp'])) player.aimDirection = { x: -1, y: -1 };
            if (keys['d'] && (keys['w'] || keys['ArrowUp'])) player.aimDirection = { x: 1, y: -1 };

            // Shooting (can't shoot while trapped)
            if (!gameState.vineTrapped && keys[' ']) {
                shoot();
            }

            // Abilities
            if (keys['x']) {
                useShield();
            }
            if (keys['z']) {
                useLaser();
            }
            if (keys['c']) {
                useSwordRain();
            }

            // Update shield duration in frames
            if (gameState.shieldDuration > 0) {
                gameState.shieldDuration -= 16; // ~60fps
                if (gameState.shieldDuration <= 0) {
                    gameState.shieldActive = false;
                }
            }

            // Update finger snap effect
            if (fingerSnapEffect) {
                const elapsed = Date.now() - fingerSnapEffect.startTime;
                if (elapsed > fingerSnapEffect.duration) {
                    fingerSnapEffect = null;
                }
            }

            // Update portals
            portals.forEach((portal, index) => {
                const elapsed = Date.now() - portal.startTime;
                if (elapsed > portal.duration) {
                    portals.splice(index, 1);
                }
            });

            // Update swords
            swords.forEach((sword, index) => {
                sword.y += sword.speed;
                
                if (sword.y > canvas.height) {
                    swords.splice(index, 1);
                    return;
                }
                
                // Check sword collision with enemies
                if (!sword.hit) {
                    enemies.forEach((enemy, enemyIndex) => {
                        const dx = sword.x - enemy.x;
                        const dy = sword.y - enemy.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 25) {
                            sword.hit = true;
                            enemy.hp -= sword.damage;
                            gameState.totalDamageDealt += sword.damage;
                            document.getElementById('gameDamageDisplay').textContent = gameState.totalDamageDealt;
                            
                            addFloatingText(enemy.x, enemy.y - 20, `-${sword.damage}`, '#FF00FF');
                            createParticles(enemy.x, enemy.y, '#FF00FF', 6);
                            
                            if (enemy.hp <= 0) {
                                handleEnemyDeath(enemy, enemyIndex);
                            }
                        }
                    });
                    
                    // NOVO: Check sword collision with boss segments
                    if (boss && boss.type === 'snake_boss' && !sword.hit) {
                        boss.segments.forEach((segment, segmentIndex) => {
                            if (segment.destroyed) return;
                            
                            const dx = sword.x - segment.x;
                            const dy = sword.y - segment.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            if (distance < 30) {
                                sword.hit = true;
                                
                                // Only head can be damaged if all segments destroyed
                                if (segment.isHead && !boss.headVulnerable) {
                                    addFloatingText(segment.x, segment.y - 30, 'PROTEGIDA!', '#FF0000');
                                    return;
                                }
                                
                                segment.hp -= sword.damage;
                                gameState.totalDamageDealt += sword.damage;
                                document.getElementById('gameDamageDisplay').textContent = gameState.totalDamageDealt;
                                
                                addFloatingText(segment.x, segment.y - 30, `-${sword.damage}`, '#FF00FF');
                                createParticles(segment.x, segment.y, '#FF0000', 8);
                                
                                if (segment.hp <= 0) {
                                    segment.destroyed = true;
                                    if (segment.isHead) {
                                        boss.hp = 0;
                                        updateBossHealthBar();
                                        discoverAchievement('snake_boss');
                                        createParticles(segment.x, segment.y, '#FFD700', 30);
                                        winLevel();
                                    } else {
                                        updateSegmentInfo();
                                        createParticles(segment.x, segment.y, '#32CD32', 15);
                                    }
                                }
                            }
                        });
                    }
                    
                    // Check sword collision with ball boss
                    if (boss && boss.type === 'ball_boss' && !sword.hit) {
                        const dx = sword.x - boss.x;
                        const dy = sword.y - boss.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 30) {
                            sword.hit = true;
                            boss.hp -= sword.damage;
                            gameState.totalDamageDealt += sword.damage;
                            document.getElementById('gameDamageDisplay').textContent = gameState.totalDamageDealt;
                            updateBossHealthBar();
                            
                            addFloatingText(boss.x, boss.y - 30, `-${sword.damage}`, '#FF00FF');
                            createParticles(boss.x, boss.y, '#FF0000', 8);
                            
                            if (boss.hp <= 0) {
                                discoverAchievement('boss_enemy');
                                createParticles(boss.x, boss.y, '#FFD700', 20);
                                winLevel();
                            }
                        }
                    }

                    // Check sword collision with spaceships
                    spaceships.forEach((spaceship, spaceshipIndex) => {
                        const dx = sword.x - spaceship.x;
                        const dy = sword.y - spaceship.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 30) {
                            sword.hit = true;
                            spaceship.hp -= sword.damage;
                            createParticles(spaceship.x, spaceship.y, '#FF8800', 6);
                            
                            if (spaceship.hp <= 0) {
                                handleSpaceshipDeath(spaceship, spaceshipIndex);
                            }
                        }
                    });

                    // Check sword collision with vines
                    vines.forEach((vine, vineIndex) => {
                        const dx = sword.x - vine.x;
                        const dy = sword.y - vine.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 25) {
                            sword.hit = true;
                            vine.hp -= sword.damage;
                            createParticles(vine.x, vine.y, '#228B22', 6);
                            
                            if (vine.hp <= 0) {
                                vines.splice(vineIndex, 1);
                                addFloatingText(vine.x, vine.y, 'VINHA DESTRU√çDA!', '#00FF00');
                                createParticles(vine.x, vine.y, '#00FF00', 10);
                            }
                        }
                    });
                }
            });

            // Update bullets
            bullets.forEach((bullet, index) => {
                bullet.x += bullet.dx * 8;
                bullet.y += bullet.dy * 8;
                
                // Check collision with enemy bullets (for level 4)
                if (window.enemyBullets) {
                    window.enemyBullets.forEach((enemyBullet, enemyBulletIndex) => {
                        const dx = bullet.x - enemyBullet.x;
                        const dy = bullet.y - enemyBullet.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 10) {
                            bullets.splice(index, 1);
                            window.enemyBullets.splice(enemyBulletIndex, 1);
                            createParticles(bullet.x, bullet.y, '#FFFF00', 4);
                        }
                    });
                }
                
                if (bullet.x < 0 || bullet.x > canvas.width || bullet.y < 0 || bullet.y > canvas.height) {
                    bullets.splice(index, 1);
                }
            });

            // Update lasers
            lasers.forEach((laser, index) => {
                const elapsed = Date.now() - laser.startTime;
                if (elapsed > laser.duration) {
                    lasers.splice(index, 1);
                }
            });

            // Update floating texts
            floatingTexts.forEach((text, index) => {
                const elapsed = Date.now() - text.startTime;
                text.y -= 1;
                text.opacity = Math.max(0, 1 - elapsed / 1500);
                
                if (text.opacity <= 0) {
                    floatingTexts.splice(index, 1);
                }
            });

            // Update vines - can be destroyed by bullets
            vines.forEach((vine, index) => {
                // Check if player steps on vine
                const dx = vine.x - (player.x + player.width/2);
                const dy = vine.y - (player.y + player.height/2);
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 25 && !vine.triggered && !gameState.shieldActive) {
                    vine.triggered = true;
                    gameState.vineTrapped = true;
                    gameState.vineTrapDuration = 2000; // 2 seconds
                    discoverAchievement('vine_enemy');
                    createParticles(vine.x, vine.y, '#228B22', 8);
                }

                // Check bullet collision with vines
                bullets.forEach((bullet, bulletIndex) => {
                    const bdx = bullet.x - vine.x;
                    const bdy = bullet.y - vine.y;
                    const bdistance = Math.sqrt(bdx * bdx + bdy * bdy);
                    
                    if (bdistance < 20) {
                        bullets.splice(bulletIndex, 1);
                        vine.hp -= 1; // 1 shot to kill
                        createParticles(vine.x, vine.y, '#228B22', 4);
                        
                        if (vine.hp <= 0) {
                            vines.splice(index, 1);
                            addFloatingText(vine.x, vine.y, 'VINHA DESTRU√çDA!', '#00FF00');
                            createParticles(vine.x, vine.y, '#00FF00', 10);
                        }
                    }
                });
            });

            // Update tentacle attacks
            tentacleAttacks.forEach((attack, index) => {
                const elapsed = Date.now() - attack.startTime;
                
                if (elapsed > attack.warningDuration && !attack.active) {
                    attack.active = true;
                    document.getElementById('tentacleWarning').classList.add('hidden');
                    for (let i = 0; i < 5; i++) {
                        createParticles(
                            attack.side === 'left' ? canvas.width / 4 : (canvas.width * 3) / 4,
                            canvas.height - 50,
                            '#228B22',
                            8
                        );
                    }
                }
                
                if (attack.active && elapsed > attack.warningDuration + attack.duration) {
                    tentacleAttacks.splice(index, 1);
                }
                
                if (attack.active) {
                    // Check if player is in tentacle area
                    if (attack.side === 'left') {
                        if (player.x < canvas.width / 2 && !gameState.shieldActive) {
                            player.hp -= 30;
                            tentacleAttacks.splice(index, 1);
                            document.getElementById('playerHP').textContent = player.hp;
                            createParticles(player.x + player.width/2, player.y + player.height/2, '#FF0000', 10);
                            if (player.hp <= 0) {
                                gameOver();
                            }
                        }
                    } else {
                        if (player.x > canvas.width / 2 && !gameState.shieldActive) {
                            player.hp -= 30;
                            tentacleAttacks.splice(index, 1);
                            document.getElementById('playerHP').textContent = player.hp;
                            createParticles(player.x + player.width/2, player.y + player.height/2, '#FF0000', 10);
                            if (player.hp <= 0) {
                                gameOver();
                            }
                        }
                    }
                }
            });

            // Level-specific logic
            if (gameState.currentLevel === 3 && boss && boss.type === 'ball_boss') {
                updateBallBoss();
            } else if (gameState.currentLevel === 8 && boss && boss.type === 'snake_boss') {
                updateSnakeBoss();
            } else if (gameState.currentLevel === 4) {
                updateLevel4Logic();
            } else if (gameState.currentLevel === 5) {
                updateWorld2Level1Logic();
            } else if (gameState.currentLevel === 6) {
                updateWorld2Level2Logic();
            } else if (gameState.currentLevel === 7) {
                updateWorld2Level3Logic();
            } else {
                updateNormalLevelLogic();
            }

            updateGeneralEnemyLogic();
        }

        function handleEnemyDeath(enemy, enemyIndex) {
            let money = 1;
            if (enemy.type === 'rolling') money = 3;
            if (enemy.type === 'rectangle') money = 5;
            if (enemy.type === 'big') money = 2;
            
            addFloatingText(enemy.x, enemy.y, `+${money}`, '#00FF00');
            createParticles(enemy.x, enemy.y, '#FFD700', 8);
            
            // Discover achievement
            if (enemy.type === 'small') discoverAchievement('small_enemy');
            else if (enemy.type === 'big') discoverAchievement('big_enemy');
            else if (enemy.type === 'rolling') discoverAchievement('rolling_enemy');
            else if (enemy.type === 'rectangle') discoverAchievement('rectangle_enemy');
            else if (enemy.type === 'minion') discoverAchievement('minion_enemy');
            
            enemies.splice(enemyIndex, 1);
            gameState.money += money;
            updateMoneyDisplay();
        }

        function handleSpaceshipDeath(spaceship, spaceshipIndex) {
            spaceships.splice(spaceshipIndex, 1);
            gameState.money += 10;
            updateMoneyDisplay();
            createParticles(spaceship.x, spaceship.y, '#FF8800', 12);
            
            // 50% chance to drop a ball
            if (Math.random() < 0.5) {
                gameState.ballsSaved++;
                updateBallsDisplay();
                addFloatingText(spaceship.x, spaceship.y, '+1 BOLA!', '#0080FF');
                createParticles(spaceship.x, spaceship.y, '#0080FF', 8);
            }
        }

        function updateLevel4Logic() {
            const currentTime = Date.now();
            
            // Spawn rectangle enemies every 5 seconds, stop spawning after 30 seconds have passed
            if (currentTime - lastEnemySpawn > 5000 && !gameState.cutsceneActive && gameTime > 30) {
                // Spawn rectangles from ground level
                spawnRectangleEnemy('left', 0);
                spawnRectangleEnemy('right', 0);
                lastEnemySpawn = currentTime;
            }
            
            if (gameTime <= 0 && enemies.length === 0) {
                winLevel();
            }
        }

        function updateWorld2Level1Logic() {
            const currentTime = Date.now();
            
            // Spawn rectangle enemies and vines
            if (currentTime - lastEnemySpawn > 4000 && !gameState.cutsceneActive && gameTime > 0) {
                spawnRectangleEnemy('left', 0);
                spawnRectangleEnemy('right', 0);
                spawnVine();
                lastEnemySpawn = currentTime;
            }
            
            if (gameTime <= 0 && enemies.length === 0) {
                winLevel();
            }
        }

        function updateWorld2Level2Logic() {
            const currentTime = Date.now();
            
            // Spawn spaceships every 8 seconds
            if (currentTime - lastEnemySpawn > 8000 && !gameState.cutsceneActive && gameTime > 0) {
                spawnSpaceship();
                lastEnemySpawn = currentTime;
            }
            
            if (gameTime <= 0 && spaceships.length === 0) {
                winLevel();
            }
        }

        function updateWorld2Level3Logic() {
            const currentTime = Date.now();
            
            // Spawn rectangles, vines, and blue servants more frequently
            if (currentTime - lastEnemySpawn > 3000 && !gameState.cutsceneActive && gameTime > 0) {
                spawnRectangleEnemy('left', 0);
                spawnRectangleEnemy('right', 0);
                spawnVine();
                spawnVine(); // Extra vine
                
                // Spawn blue servants occasionally
                if (Math.random() < 0.3) {
                    spawnSmallEnemy();
                }
                
                lastEnemySpawn = currentTime;
            }
            
            // Tentacle attacks twice during the level
            if ((gameTime === 30 || gameTime === 15) && tentacleAttacks.length === 0) {
                spawnTentacleAttack();
            }
            
            if (gameTime <= 0 && enemies.length === 0) {
                winLevel();
            }
        }

        function updateNormalLevelLogic() {
            // Normal enemy spawning for levels 1 and 2
            const currentTime = Date.now();
            
            if (currentTime - lastEnemySpawn > 3000 && !gameState.cutsceneActive && gameTime > 0) {
                spawnSmallEnemy();
                if (gameState.currentLevel === 2) {
                    spawnSmallEnemy();
                } else {
                    spawnSmallEnemy();
                }
                lastEnemySpawn = currentTime;
            }
            
            if (currentTime - lastBigEnemySpawn > 7000 && !gameState.cutsceneActive && gameTime > 0) {
                spawnBigEnemy();
                lastBigEnemySpawn = currentTime;
            }

            if (gameState.currentLevel === 2 && currentTime - lastRollingEnemySpawn > 10000 && !gameState.cutsceneActive && gameTime > 0) {
                spawnRollingEnemy();
                lastRollingEnemySpawn = currentTime;
            }
            
            if (gameTime <= 0 && enemies.length === 0) {
                winLevel();
            }
        }

        function updateGeneralEnemyLogic() {
            // Update bombs
            bombs.forEach((bomb, index) => {
                bomb.y += bomb.speed;
                
                // Check if bomb hits player
                const dx = bomb.x - (player.x + player.width/2);
                const dy = bomb.y - (player.y + player.height/2);
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 25 && !bomb.destroyed && !gameState.shieldActive) {
                    player.hp -= 10;
                    bombs.splice(index, 1);
                    document.getElementById('playerHP').textContent = player.hp;
                    createParticles(bomb.x, bomb.y, '#FF4500', 10);
                    createParticles(player.x + player.width/2, player.y + player.height/2, '#FF0000', 8);
                    
                    if (player.hp <= 0) {
                        gameOver();
                    }
                }
                
                // Check if bullet hits bomb
                bullets.forEach((bullet, bulletIndex) => {
                    const bdx = bullet.x - bomb.x;
                    const bdy = bullet.y - bomb.y;
                    const bdistance = Math.sqrt(bdx * bdx + bdy * bdy);
                    
                    if (bdistance < 15 && !bomb.destroyed) {
                        bomb.destroyed = true;
                        bullets.splice(bulletIndex, 1);
                        bombs.splice(index, 1);
                        addFloatingText(bomb.x, bomb.y, 'BOMBA DESTRU√çDA!', '#00FF00');
                        discoverAchievement('bomb');
                        createParticles(bomb.x, bomb.y, '#FFD700', 12);
                    }
                });
                
                // Remove bomb if it goes off screen
                if (bomb.y > canvas.height) {
                    bombs.splice(index, 1);
                }
            });

            // Update regular enemies
            enemies.forEach((enemy, enemyIndex) => {
                if (enemy.type === 'small') {
                    const dx = player.x - enemy.x;
                    const dy = player.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 0) {
                        enemy.x += (dx / distance) * enemy.speed;
                        enemy.y += (dy / distance) * enemy.speed;
                    }
                    
                    if (distance < 30 && !gameState.shieldActive) {
                        player.hp -= 5;
                        enemies.splice(enemyIndex, 1);
                        document.getElementById('playerHP').textContent = player.hp;
                        createParticles(enemy.x, enemy.y, '#0000FF', 6);
                        createParticles(player.x + player.width/2, player.y + player.height/2, '#FF0000', 6);
                        
                        if (player.hp <= 0) {
                            gameOver();
                        }
                    }
                } else if (enemy.type === 'big') {
                    const currentTime = Date.now();
                    if (currentTime - enemy.lastShot > 2000) {
                        shootEnemyBullet(enemy);
                        enemy.lastShot = currentTime;
                    }
                } else if (enemy.type === 'rolling') {
                    enemy.x += enemy.direction * enemy.speed;
                    
                    const dx = player.x - enemy.x;
                    const dy = player.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 35 && !gameState.shieldActive) {
                        player.hp -= 30;
                        enemies.splice(enemyIndex, 1);
                        document.getElementById('playerHP').textContent = player.hp;
                        createParticles(enemy.x, enemy.y, '#00AA00', 10);
                        createParticles(player.x + player.width/2, player.y + player.height/2, '#FF0000', 10);
                        
                        if (player.hp <= 0) {
                            gameOver();
                        }
                    }
                    
                    if (enemy.x < -50 || enemy.x > canvas.width + 50) {
                        enemies.splice(enemyIndex, 1);
                    }
                } else if (enemy.type === 'minion') {
                    // Minions move toward player
                    const dx = player.x - enemy.x;
                    const dy = player.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 0) {
                        enemy.x += (dx / distance) * enemy.speed;
                        enemy.y += (dy / distance) * enemy.speed;
                    }
                    
                    if (distance < 25 && !gameState.shieldActive) {
                        player.hp -= 5;
                        enemies.splice(enemyIndex, 1);
                        document.getElementById('playerHP').textContent = player.hp;
                        createParticles(enemy.x, enemy.y, '#FFA500', 6);
                        createParticles(player.x + player.width/2, player.y + player.height/2, '#FF0000', 6);
                        
                        if (player.hp <= 0) {
                            gameOver();
                        }
                    }
                } else if (enemy.type === 'rectangle') {
                    // Rectangle enemies - Move toward player slower
                    const dx = player.x - enemy.x;
                    const dy = player.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 0) {
                        enemy.x += (dx / distance) * enemy.speed;
                        enemy.y += (dy / distance) * enemy.speed;
                    }
                    
                    const currentTime = Date.now();
                    if (currentTime - enemy.lastShot > 2000) {
                        shootPoisonBullet(enemy);
                        enemy.lastShot = currentTime;
                    }
                    
                    if (distance < 30 && !gameState.shieldActive) {
                        player.hp -= 12;
                        enemies.splice(enemyIndex, 1);
                        document.getElementById('playerHP').textContent = player.hp;
                        createParticles(enemy.x, enemy.y, '#32CD32', 8);
                        createParticles(player.x + player.width/2, player.y + player.height/2, '#FF0000', 8);
                        
                        if (player.hp <= 0) {
                            gameOver();
                        }
                    }
                }

                // Check bullet collisions with enemies
                bullets.forEach((bullet, bulletIndex) => {
                    const dx = bullet.x - enemy.x;
                    const dy = bullet.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 20) {
                        bullets.splice(bulletIndex, 1);
                        
                        // Damage based on upgrades
                        let damage = 1;
                        if (gameState.hasShotMaster) damage = 3;
                        else if (gameState.hasShotUpgrade) damage = 2;
                        
                        enemy.hp -= damage;
                        gameState.totalDamageDealt += damage;
                        document.getElementById('gameDamageDisplay').textContent = gameState.totalDamageDealt;
                        
                        createParticles(enemy.x, enemy.y, '#FFFF00', 4);
                        
                        if (enemy.hp <= 0) {
                            handleEnemyDeath(enemy, enemyIndex);
                        }
                    }
                });

                // Check laser collisions with enemies
                lasers.forEach((laser, laserIndex) => {
                    if (enemy.x > laser.x - laser.width/2 && enemy.x < laser.x + laser.width/2 && 
                        enemy.y > laser.y && enemy.y < laser.y + laser.height && !laser.damaged) {
                        let damage = laser.damage || 50;
                        if (enemy.type === 'rolling') damage = Math.min(damage, 3);
                        if (enemy.type === 'rectangle') damage = Math.min(damage, 5);
                        
                        enemy.hp -= damage;
                        gameState.totalDamageDealt += damage;
                        document.getElementById('gameDamageDisplay').textContent = gameState.totalDamageDealt;
                        laser.damaged = true;
                        
                        createParticles(enemy.x, enemy.y, '#00AAFF', 8);
                        
                        if (enemy.hp <= 0) {
                            handleEnemyDeath(enemy, enemyIndex);
                        }
                    }
                });
            });

            // Update spaceships
            spaceships.forEach((spaceship, index) => {
                const currentTime = Date.now();
                
                // Shooting pattern
                if (currentTime - spaceship.lastNormalShot > 3000) {
                    shootSpaceshipBullet(spaceship, 'normal');
                    spaceship.lastNormalShot = currentTime;
                }
                
                if (currentTime - spaceship.lastLaserShot > 8000) {
                    spaceship.laserWarning = true;
                    spaceship.laserWarningStart = currentTime;
                    spaceship.lastLaserShot = currentTime;
                }
                
                // Laser warning and execution
                if (spaceship.laserWarning) {
                    const warningElapsed = currentTime - spaceship.laserWarningStart;
                    if (warningElapsed > 1500) { // 1.5 second warning
                        shootSpaceshipBullet(spaceship, 'laser');
                        spaceship.laserWarning = false;
                    }
                }
                
                // Check bullet collisions with spaceships
                bullets.forEach((bullet, bulletIndex) => {
                    const dx = bullet.x - spaceship.x;
                    const dy = bullet.y - spaceship.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 30) {
                        bullets.splice(bulletIndex, 1);
                        
                        let damage = 1;
                        if (gameState.hasShotMaster) damage = 3;
                        else if (gameState.hasShotUpgrade) damage = 2;
                        
                        spaceship.hp -= damage;
                        createParticles(spaceship.x, spaceship.y, '#FFFF00', 4);
                        
                        if (spaceship.hp <= 0) {
                            handleSpaceshipDeath(spaceship, index);
                        }
                    }
                });

                // Check laser collisions with spaceships
                lasers.forEach((laser, laserIndex) => {
                    if (spaceship.x > laser.x - laser.width/2 && spaceship.x < laser.x + laser.width/2 && 
                        spaceship.y > laser.y && spaceship.y < laser.y + laser.height && !laser.damaged) {
                        let damage = laser.damage || 50;
                        
                        spaceship.hp -= damage;
                        laser.damaged = true;
                        createParticles(spaceship.x, spaceship.y, '#00AAFF', 8);
                        
                        if (spaceship.hp <= 0) {
                            handleSpaceshipDeath(spaceship, index);
                        }
                    }
                });
            });

            // Update enemy bullets
            if (window.enemyBullets) {
                window.enemyBullets.forEach((bullet, index) => {
                    bullet.x += bullet.dx * 6;
                    bullet.y += bullet.dy * 6;
                    
                    const dx = bullet.x - (player.x + player.width/2);
                    const dy = bullet.y - (player.y + player.height/2);
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 20 && !gameState.shieldActive) {
                        player.hp -= (bullet.poison ? 15 : (bullet.laser ? 25 : 10));
                        window.enemyBullets.splice(index, 1);
                        document.getElementById('playerHP').textContent = player.hp;
                        
                        if (bullet.poison) {
                            discoverAchievement('poison_bullet');
                            createParticles(player.x + player.width/2, player.y + player.height/2, '#8A2BE2', 8);
                        } else if (bullet.laser) {
                            createParticles(player.x + player.width/2, player.y + player.height/2, '#FF0000', 10);
                        } else {
                            createParticles(player.x + player.width/2, player.y + player.height/2, '#FF0000', 6);
                        }
                        
                        if (player.hp <= 0) {
                            gameOver();
                        }
                    }
                    
                    if (bullet.x < 0 || bullet.x > canvas.width || bullet.y < 0 || bullet.y > canvas.height) {
                        window.enemyBullets.splice(index, 1);
                    }
                });
            }
        }

        function updateBallBoss() {
            const currentTime = Date.now();
            
            // Determine boss phase based on health
            if (boss.hp <= boss.maxHP * 0.3) {
                boss.phase = 3; // Enraged phase
            } else if (boss.hp <= boss.maxHP * 0.6) {
                boss.phase = 2; // Angry phase
            } else {
                boss.phase = 1; // Normal phase
            }
            
            // Boss slam attack warning system
            if (boss.slamWarning) {
                const warningElapsed = currentTime - boss.warningStartTime;
                if (warningElapsed >= 1500) { // 1.5 seconds warning
                    boss.slamWarning = false;
                    boss.isSlam = true;
                    boss.slamStartY = boss.y;
                    boss.slamSpeed = 2 + boss.phase;
                    boss.x = player.x + player.width/2;
                    document.getElementById('bossWarning').classList.add('hidden');
                    createParticles(boss.x, boss.y, '#FF0000', 12);
                }
            }
            
            // Boss slam attack
            if (boss.isSlam) {
                boss.y += boss.slamSpeed;
                boss.slamSpeed += 0.8;
                
                // Check if boss hits player
                const dx = boss.x - (player.x + player.width/2);
                const dy = boss.y - (player.y + player.height/2);
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 40 && !gameState.shieldActive) {
                    player.hp -= (boss.phase * 15);
                    document.getElementById('playerHP').textContent = player.hp;
                    boss.isSlam = false;
                    boss.y = 150;
                    boss.lastAttack = currentTime;
                    createParticles(player.x + player.width/2, player.y + player.height/2, '#FF0000', 15);
                    
                    if (player.hp <= 0) {
                        gameOver();
                        return;
                    }
                }
                
                // If boss hits ground, reset
                if (boss.y > canvas.height - 100) {
                    boss.isSlam = false;
                    boss.y = 150;
                    boss.lastAttack = currentTime;
                    createParticles(boss.x, canvas.height - 50, '#8B4513', 20);
                }
            }
            
            // Boss attack pattern
            const attackInterval = Math.max(1000, 2500 - (boss.phase * 400));
            if (currentTime - boss.lastAttack > attackInterval && !boss.isSlam && !boss.slamWarning) {
                let attackType;
                
                if (boss.phase === 3) {
                    attackType = Math.floor(Math.random() * 4);
                } else if (boss.phase === 2) {
                    attackType = Math.floor(Math.random() * 3);
                } else {
                    attackType = Math.floor(Math.random() * 3);
                }
                
                if (attackType === 0) {
                    spawnBombs(boss.phase + 1);
                    boss.lastAttack = currentTime;
                } else if (attackType === 1) {
                    // Start slam warning
                    boss.slamWarning = true;
                    boss.warningStartTime = currentTime;
                    document.getElementById('bossWarning').classList.remove('hidden');
                } else if (attackType === 2) {
                    spawnMinions(boss.phase + 1);
                    boss.lastAttack = currentTime;
                } else if (attackType === 3 && boss.phase === 3) {
                    for (let i = 0; i < 6; i++) {
                        setTimeout(() => spawnBombs(1), i * 250);
                    }
                    boss.lastAttack = currentTime;
                }
            }
            
            // Check bullet collisions with boss
            bullets.forEach((bullet, bulletIndex) => {
                const dx = bullet.x - boss.x;
                const dy = bullet.y - boss.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 30) {
                    bullets.splice(bulletIndex, 1);
                    
                    let damage = 1;
                    if (gameState.hasShotMaster) damage = 3;
                    else if (gameState.hasShotUpgrade) damage = 2;
                    
                    boss.hp -= damage;
                    gameState.totalDamageDealt += damage;
                    document.getElementById('gameDamageDisplay').textContent = gameState.totalDamageDealt;
                    updateBossHealthBar();
                    
                    addFloatingText(boss.x, boss.y - 30, `-${damage}`, '#FF0000');
                    createParticles(boss.x, boss.y, '#FF0000', 6);
                    
                    if (boss.hp <= 0) {
                        discoverAchievement('boss_enemy');
                        createParticles(boss.x, boss.y, '#FFD700', 25);
                        winLevel();
                    }
                }
            });
            
            // Check laser collisions with boss
            lasers.forEach((laser, laserIndex) => {
                if (boss.x > laser.x - laser.width/2 && boss.x < laser.x + laser.width/2 && 
                    boss.y > laser.y && boss.y < laser.y + laser.height && !laser.damaged) {
                    let damage = laser.damage || 50;
                    boss.hp -= damage;
                    gameState.totalDamageDealt += damage;
                    document.getElementById('gameDamageDisplay').textContent = gameState.totalDamageDealt;
                    updateBossHealthBar();
                    laser.damaged = true;
                    
                    addFloatingText(boss.x, boss.y - 30, `-${damage}`, '#FF0000');
                    createParticles(boss.x, boss.y, '#00AAFF', 15);
                    
                    if (boss.hp <= 0) {
                        discoverAchievement('boss_enemy');
                        createParticles(boss.x, boss.y, '#FFD700', 25);
                        winLevel();
                    }
                }
            });
        }

        // NOVO: Boss Cobra ULTRA DIF√çCIL atualizado
        function updateSnakeBoss() {
            const currentTime = Date.now();
            
            // Determine boss phase based on health
            if (boss.hp <= boss.maxHP * 0.5 && !boss.arenaCreated) {
                boss.arenaCreated = true;
                boss.phase = 2;
                // Show arena cutscene during gameplay
                showArenaCutscene();
            } else if (boss.hp <= boss.maxHP * 0.7) {
                boss.phase = 1;
            }
            
            // Animate snake segments
            boss.segments.forEach((segment, index) => {
                if (!segment.destroyed) {
                    segment.y = segment.baseY + Math.sin(Date.now() * 0.002 + index * 0.5) * 15;
                }
            });
            
            // Boss bite warning system
            if (boss.biteWarning) {
                const warningElapsed = currentTime - boss.biteWarningStartTime;
                if (warningElapsed >= 1500) { // 1.5 seconds warning
                    boss.biteWarning = false;
                    // Execute bite attack - only if head exists
                    const headSegment = boss.segments.find(seg => seg.isHead && !seg.destroyed);
                    if (headSegment) {
                        const dx = headSegment.x - (player.x + player.width/2);
                        const dy = headSegment.y - (player.y + player.height/2);
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        createParticles(headSegment.x, headSegment.y, '#228B22', 15);
                        
                        if (distance < 60 && !gameState.shieldActive) {
                            player.hp -= 35;
                            document.getElementById('playerHP').textContent = player.hp;
                            createParticles(player.x + player.width/2, player.y + player.height/2, '#FF0000', 12);
                            
                            if (player.hp <= 0) {
                                gameOver();
                                return;
                            }
                        }
                    }
                    boss.lastAttack = currentTime;
                    document.getElementById('bossWarning').classList.add('hidden');
                }
            }
            
            // Boss attack pattern - ULTRA DIF√çCIL: ataques muito mais frequentes
            const attackInterval = boss.phase === 2 ? 800 : 1500; // MUITO mais r√°pido
            if (currentTime - boss.lastAttack > attackInterval && !boss.biteWarning) {
                let attackType;
                
                if (boss.phase === 2) {
                    attackType = Math.floor(Math.random() * 4); // Include bite attack
                } else {
                    attackType = Math.floor(Math.random() * 3);
                }
                
                if (attackType === 0) {
                    // Tentacle attack
                    spawnTentacleAttack();
                    boss.lastAttack = currentTime;
                } else if (attackType === 1) {
                    // Poison rain attack - ULTRA DIF√çCIL: muito mais proj√©teis
                    spawnPoisonRain(20); // Aumentado de 12 para 20!
                    boss.lastAttack = currentTime;
                } else if (attackType === 2) {
                    // Vine spawn - ULTRA DIF√çCIL: muitas mais vinhas
                    for (let i = 0; i < 5; i++) { // 5 vinhas de uma vez!
                        spawnVine();
                    }
                    boss.lastAttack = currentTime;
                } else if (attackType === 3 && boss.phase === 2) {
                    // Bite attack (phase 2 only) - only if head exists
                    const headSegment = boss.segments.find(seg => seg.isHead && !seg.destroyed);
                    if (headSegment) {
                        boss.biteWarning = true;
                        boss.biteWarningStartTime = currentTime;
                        document.getElementById('bossWarning').classList.remove('hidden');
                    }
                }
            }
            
            // NOVO: Check bullet collisions with snake segments
            bullets.forEach((bullet, bulletIndex) => {
                boss.segments.forEach((segment, segmentIndex) => {
                    if (segment.destroyed) return;
                    
                    const dx = bullet.x - segment.x;
                    const dy = bullet.y - segment.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 30) {
                        bullets.splice(bulletIndex, 1);
                        
                        // Only head can be damaged if all segments destroyed
                        if (segment.isHead && !boss.headVulnerable) {
                            addFloatingText(segment.x, segment.y - 30, 'PROTEGIDA!', '#FF0000');
                            createParticles(segment.x, segment.y, '#888888', 4);
                            return;
                        }
                        
                        let damage = 1;
                        if (gameState.hasShotMaster) damage = 3;
                        else if (gameState.hasShotUpgrade) damage = 2;
                        
                        segment.hp -= damage;
                        gameState.totalDamageDealt += damage;
                        document.getElementById('gameDamageDisplay').textContent = gameState.totalDamageDealt;
                        
                        addFloatingText(segment.x, segment.y - 30, `-${damage}`, '#FF0000');
                        createParticles(segment.x, segment.y, '#228B22', 6);
                        
                        if (segment.hp <= 0) {
                            segment.destroyed = true;
                            if (segment.isHead) {
                                boss.hp = 0;
                                updateBossHealthBar();
                                discoverAchievement('snake_boss');
                                createParticles(segment.x, segment.y, '#FFD700', 30);
                                winLevel();
                            } else {
                                updateSegmentInfo();
                                createParticles(segment.x, segment.y, '#32CD32', 15);
                            }
                        }
                    }
                });
            });
            
            // NOVO: Check laser collisions with snake segments
            lasers.forEach((laser, laserIndex) => {
                boss.segments.forEach((segment, segmentIndex) => {
                    if (segment.destroyed) return;
                    
                    if (segment.x > laser.x - laser.width/2 && segment.x < laser.x + laser.width/2 && 
                        segment.y > laser.y && segment.y < laser.y + laser.height && !laser.damaged) {
                        
                        // Only head can be damaged if all segments destroyed
                        if (segment.isHead && !boss.headVulnerable) {
                            addFloatingText(segment.x, segment.y - 30, 'PROTEGIDA!', '#FF0000');
                            createParticles(segment.x, segment.y, '#888888', 8);
                            return;
                        }
                        
                        let damage = laser.damage || 50;
                        segment.hp -= damage;
                        gameState.totalDamageDealt += damage;
                        document.getElementById('gameDamageDisplay').textContent = gameState.totalDamageDealt;
                        laser.damaged = true;
                        
                        addFloatingText(segment.x, segment.y - 30, `-${damage}`, '#FF0000');
                        createParticles(segment.x, segment.y, '#00AAFF', 15);
                        
                        if (segment.hp <= 0) {
                            segment.destroyed = true;
                            if (segment.isHead) {
                                boss.hp = 0;
                                updateBossHealthBar();
                                discoverAchievement('snake_boss');
                                createParticles(segment.x, segment.y, '#FFD700', 30);
                                winLevel();
                            } else {
                                updateSegmentInfo();
                                createParticles(segment.x, segment.y, '#32CD32', 15);
                            }
                        }
                    }
                });
            });
        }

        function showArenaCutscene() {
            // Brief in-game cutscene showing arena creation
            gameState.cutsceneActive = true;
            document.getElementById('cutsceneOverlay').classList.remove('hidden');
            document.getElementById('cutsceneContent').textContent = 'A cobra cria uma arena de tent√°culos! A batalha se intensifica!';
            
            setTimeout(() => {
                gameState.cutsceneActive = false;
                document.getElementById('cutsceneOverlay').classList.add('hidden');
            }, 2000);
        }

        function spawnBombs(count = 2) {
            for (let i = 0; i < count; i++) {
                bombs.push({
                    x: Math.random() * (canvas.width - 100) + 50,
                    y: 50,
                    speed: 3 + Math.random() * 2,
                    destroyed: false
                });
            }
            createParticles(canvas.width / 2, 50, '#FF4500', 8);
        }

        function spawnMinions(count = 2) {
            for (let i = 0; i < count; i++) {
                enemies.push({
                    type: 'minion',
                    x: boss.x + (i === 0 ? -50 : 50),
                    y: boss.y,
                    hp: 1,
                    speed: 2 + Math.random()
                });
            }
            createParticles(boss.x, boss.y, '#FFA500', 10);
        }

        function spawnRectangleEnemy(side, index) {
            const x = side === 'left' ? -30 : canvas.width + 30;
            const y = canvas.height - 100; // Ground level
            
            enemies.push({
                type: 'rectangle',
                x: x,
                y: y,
                hp: 3,
                speed: 0.8,
                direction: side === 'left' ? 1 : -1,
                lastShot: Date.now() + (index * 500)
            });
        }

        function spawnVine() {
            vines.push({
                x: Math.random() * (canvas.width - 100) + 50,
                y: canvas.height - 80,
                hp: 1,
                triggered: false
            });
        }

        function spawnSpaceship() {
            spaceships.push({
                x: Math.random() * (canvas.width - 100) + 50,
                y: 100 + Math.random() * 100,
                hp: 6,
                lastNormalShot: 0,
                lastLaserShot: 0,
                laserWarning: false,
                laserWarningStart: 0
            });
        }

        function spawnTentacleAttack() {
            const side = Math.random() < 0.5 ? 'left' : 'right';
            
            tentacleAttacks.push({
                side: side,
                startTime: Date.now(),
                warningDuration: 2000, // 2 seconds warning
                duration: 1000, // 1 second active
                active: false
            });
            
            document.getElementById('tentacleWarning').classList.remove('hidden');
        }

        function spawnPoisonRain(count = 8) {
            // Spawn multiple poison projectiles from the sky
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    if (!window.enemyBullets) window.enemyBullets = [];
                    
                    window.enemyBullets.push({
                        x: Math.random() * canvas.width,
                        y: 0,
                        dx: 0,
                        dy: 1,
                        poison: true
                    });
                    
                    createParticles(Math.random() * canvas.width, 0, '#8A2BE2', 4);
                }, i * 100); // ULTRA DIF√çCIL: intervalo muito menor
            }
        }

        function shootPoisonBullet(enemy) {
            if (!window.enemyBullets) window.enemyBullets = [];
            
            const dx = (player.x + player.width/2) - enemy.x;
            const dy = (player.y + player.height/2) - enemy.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            window.enemyBullets.push({
                x: enemy.x,
                y: enemy.y,
                dx: dx / distance,
                dy: dy / distance,
                poison: true
            });
            
            createParticles(enemy.x, enemy.y, '#8A2BE2', 3);
        }

        function shootSpaceshipBullet(spaceship, type) {
            if (!window.enemyBullets) window.enemyBullets = [];
            
            const dx = (player.x + player.width/2) - spaceship.x;
            const dy = (player.y + player.height/2) - spaceship.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            window.enemyBullets.push({
                x: spaceship.x,
                y: spaceship.y,
                dx: dx / distance,
                dy: dy / distance,
                laser: type === 'laser'
            });
            
            createParticles(spaceship.x, spaceship.y, type === 'laser' ? '#FF0000' : '#FF8800', 4);
        }

        function render() {
            // Clear canvas and draw background based on level
            if (gameState.currentLevel === 1) {
                ctx.fillStyle = '#87CEEB';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#FFB6C1';
                for (let i = 0; i < 20; i++) {
                    const x = (i * 123) % canvas.width;
                    const y = (i * 87) % canvas.height;
                    ctx.beginPath();
                    ctx.arc(x, y, 10 + (i % 5), 0, Math.PI * 2);
                    ctx.fill();
                }
            } else if (gameState.currentLevel === 2) {
                ctx.fillStyle = '#98FB98';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(50, 450, 80, 60);
                ctx.fillRect(200, 440, 100, 70);
                ctx.fillRect(350, 460, 70, 50);
                ctx.fillRect(500, 430, 90, 80);
                ctx.fillRect(650, 450, 75, 60);
                
                ctx.fillStyle = '#B22222';
                ctx.fillRect(45, 430, 90, 20);
                ctx.fillRect(195, 420, 110, 20);
                ctx.fillRect(345, 440, 80, 20);
                ctx.fillRect(495, 410, 100, 20);
                ctx.fillRect(645, 430, 85, 20);
                
                ctx.fillStyle = '#FFB6C1';
                for (let i = 0; i < 12; i++) {
                    const x = 100 + (i * 60) % 600;
                    const y = 520 + (i % 3) * 20;
                    ctx.beginPath();
                    ctx.arc(x, y, 8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(x - 3, y - 2, 2, 2);
                    ctx.fillRect(x + 1, y - 2, 2, 2);
                    ctx.fillStyle = '#FFB6C1';
                }
            } else if (gameState.currentLevel === 3) {
                // Phase 3 background - ball planet with machine
                ctx.fillStyle = '#FFB6C1';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw planet machine
                ctx.fillStyle = '#C0C0C0';
                ctx.fillRect(350, 480, 100, 120);
                ctx.fillRect(375, 460, 50, 20);
                
                // Machine details
                ctx.fillStyle = '#0080FF';
                ctx.fillRect(370, 500, 60, 10);
                ctx.fillRect(370, 520, 60, 10);
                ctx.fillRect(370, 540, 60, 10);
                
                // Portal effect
                ctx.fillStyle = '#8A2BE2';
                ctx.beginPath();
                ctx.arc(400, 560, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // Ground
                ctx.fillStyle = '#98FB98';
                ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
            } else if (gameState.currentLevel === 4) {
                // Phase 4 background - square forest
                ctx.fillStyle = '#228B22';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Square trees
                ctx.fillStyle = '#8B4513';
                for (let i = 0; i < 8; i++) {
                    const x = 50 + i * 100;
                    const height = 80 + (i % 3) * 20;
                    ctx.fillRect(x, canvas.height - height - 50, 30, height);
                }
                
                // Square leaves
                ctx.fillStyle = '#32CD32';
                for (let i = 0; i < 8; i++) {
                    const x = 35 + i * 100;
                    const treeHeight = 80 + (i % 3) * 20;
                    ctx.fillRect(x, canvas.height - treeHeight - 100, 60, 60);
                }
                
                // Ground
                ctx.fillStyle = '#8FBC8F';
                ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
            } else if (gameState.currentLevel === 5) {
                // World 2 Level 1 - Square forest with more detail
                ctx.fillStyle = '#228B22';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Dense square forest
                ctx.fillStyle = '#8B4513';
                for (let i = 0; i < 10; i++) {
                    const x = 30 + i * 75;
                    const height = 70 + (i % 4) * 15;
                    ctx.fillRect(x, canvas.height - height - 40, 25, height);
                }
                
                // Square leaves
                ctx.fillStyle = '#32CD32';
                for (let i = 0; i < 10; i++) {
                    const x = 20 + i * 75;
                    const treeHeight = 70 + (i % 4) * 15;
                    ctx.fillRect(x, canvas.height - treeHeight - 80, 45, 45);
                }
                
                // Ground
                ctx.fillStyle = '#8FBC8F';
                ctx.fillRect(0, canvas.height - 40, canvas.width, 40);
            } else if (gameState.currentLevel === 6) {
                // World 2 Level 2 - Square village
                ctx.fillStyle = '#8FBC8F';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Village buildings
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(50, 450, 80, 100);
                ctx.fillRect(180, 440, 90, 110);
                ctx.fillRect(320, 460, 70, 90);
                ctx.fillRect(450, 450, 85, 100);
                ctx.fillRect(580, 455, 75, 95);
                ctx.fillRect(700, 465, 80, 85);
                
                // Roofs
                ctx.fillStyle = '#B22222';
                ctx.fillRect(45, 430, 90, 20);
                ctx.fillRect(175, 420, 100, 20);
                ctx.fillRect(315, 440, 80, 20);
                ctx.fillRect(445, 430, 95, 20);
                ctx.fillRect(575, 435, 85, 20);
                ctx.fillRect(695, 445, 90, 20);
                
                // Ground
                ctx.fillStyle = '#8FBC8F';
                ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
            } else if (gameState.currentLevel === 7) {
                // World 2 Level 3 - Invaded village with tentacles
                ctx.fillStyle = '#2F4F2F';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Ruined buildings
                ctx.fillStyle = '#654321';
                ctx.fillRect(50, 450, 80, 100);
                ctx.fillRect(180, 460, 90, 90);
                ctx.fillRect(320, 470, 70, 80);
                
                // Tentacles everywhere
                ctx.fillStyle = '#228B22';
                for (let i = 0; i < 15; i++) {
                    const x = 30 + i * 50;
                    const height = 60 + (i % 3) * 30;
                    ctx.fillRect(x, canvas.height - height, 15, height);
                    // Tentacle tops
                    ctx.fillRect(x - 5, canvas.height - height - 10, 25, 15);
                }
                
                // Ground
                ctx.fillStyle = '#2F4F2F';
                ctx.fillRect(0, canvas.height - 30, canvas.width, 30);
            } else if (gameState.currentLevel === 8) {
                // World 2 Level 4 - Snake boss arena
                if (boss && boss.arenaCreated) {
                    // Arena background
                    ctx.fillStyle = '#1a1a1a';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Arena walls
                    ctx.fillStyle = '#228B22';
                    ctx.fillRect(0, 0, 20, canvas.height);
                    ctx.fillRect(canvas.width - 20, 0, 20, canvas.height);
                    ctx.fillRect(0, 0, canvas.width, 20);
                    ctx.fillRect(0, canvas.height - 20, canvas.width, 20);
                    
                    // Arena floor pattern
                    ctx.fillStyle = '#2F4F2F';
                    for (let i = 0; i < canvas.width; i += 40) {
                        for (let j = 0; j < canvas.height; j += 40) {
                            ctx.fillRect(i, j, 20, 20);
                        }
                    }
                } else {
                    // Consumed village
                    ctx.fillStyle = '#2F4F2F';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Tentacles everywhere
                    ctx.fillStyle = '#228B22';
                    for (let i = 0; i < 20; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        const size = 10 + Math.random() * 20;
                        ctx.fillRect(x, y, size, size);
                    }
                }
                
                // Ground
                ctx.fillStyle = '#1F3F1F';
                ctx.fillRect(0, canvas.height - 30, canvas.width, 30);
            }

            // Draw tentacle attacks
            tentacleAttacks.forEach(attack => {
                if (attack.active) {
                    ctx.fillStyle = '#228B22';
                    if (attack.side === 'left') {
                        // Left half of screen
                        ctx.fillRect(0, canvas.height - 100, canvas.width / 2, 100);
                        
                        // Tentacle details
                        for (let i = 0; i < 8; i++) {
                            const x = i * (canvas.width / 16);
                            ctx.fillRect(x, canvas.height - 120, 15, 120);
                            ctx.fillRect(x - 5, canvas.height - 130, 25, 15);
                        }
                    } else {
                        // Right half of screen
                        ctx.fillRect(canvas.width / 2, canvas.height - 100, canvas.width / 2, 100);
                        
                        // Tentacle details
                        for (let i = 8; i < 16; i++) {
                            const x = i * (canvas.width / 16);
                            ctx.fillRect(x, canvas.height - 120, 15, 120);
                            ctx.fillRect(x - 5, canvas.height - 130, 25, 15);
                        }
                    }
                }
            });

            // Draw portals
            portals.forEach(portal => {
                const elapsed = Date.now() - portal.startTime;
                if (elapsed >= 0) {
                    const alpha = Math.max(0, 1 - elapsed / portal.duration);
                    ctx.globalAlpha = alpha;
                    
                    // Purple swirling portal
                    ctx.fillStyle = '#8A2BE2';
                    ctx.beginPath();
                    ctx.arc(portal.x, portal.y, 20, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#9932CC';
                    ctx.beginPath();
                    ctx.arc(portal.x, portal.y, 10, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.globalAlpha = 1;
                }
            });

            // Draw swords
            swords.forEach(sword => {
                ctx.fillStyle = sword.hit ? '#666666' : '#C0C0C0';
                
                // Sword blade
                ctx.fillRect(sword.x - 3, sword.y, 6, 30);
                
                // Sword hilt
                ctx.fillStyle = sword.hit ? '#444444' : '#8B4513';
                ctx.fillRect(sword.x - 5, sword.y + 30, 10, 8);
                
                // Sword guard
                ctx.fillStyle = sword.hit ? '#333333' : '#FFD700';
                ctx.fillRect(sword.x - 8, sword.y + 25, 16, 3);
            });

            // Draw finger snap effect
            if (fingerSnapEffect) {
                const elapsed = Date.now() - fingerSnapEffect.startTime;
                const alpha = Math.max(0, 1 - elapsed / fingerSnapEffect.duration);
                
                ctx.globalAlpha = alpha;
                ctx.fillStyle = '#FF0000';
                ctx.beginPath();
                ctx.arc(fingerSnapEffect.x, fingerSnapEffect.y, 30, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#FF4444';
                ctx.beginPath();
                ctx.arc(fingerSnapEffect.x, fingerSnapEffect.y, 20, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.globalAlpha = 1;
            }

            // Draw lasers
            ctx.fillStyle = '#00AAFF';
            ctx.globalAlpha = 0.8;
            lasers.forEach(laser => {
                ctx.fillRect(laser.x - laser.width/2, laser.y, laser.width, laser.height);
            });
            ctx.globalAlpha = 1;

            // Draw player
            ctx.fillStyle = gameState.vineTrapped ? '#228B22' : '#32CD32';
            ctx.beginPath();
            ctx.arc(player.x + player.width/2, player.y + player.height/2, player.width/2, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#00FF00';
            ctx.fillRect(player.x + 8, player.y + 8, 5, 5);
            ctx.fillRect(player.x + 17, player.y + 8, 5, 5);

            // Draw shield
            if (gameState.shieldActive) {
                ctx.strokeStyle = '#00AAFF';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(player.x + player.width/2, player.y + player.height/2, player.width/2 + 10, 0, Math.PI * 2);
                ctx.stroke();
            }

            // Draw vine trap effect on player
            if (gameState.vineTrapped) {
                ctx.fillStyle = '#228B22';
                for (let i = 0; i < 6; i++) {
                    const angle = (i / 6) * Math.PI * 2;
                    const x = player.x + player.width/2 + Math.cos(angle) * 25;
                    const y = player.y + player.height/2 + Math.sin(angle) * 25;
                    ctx.fillRect(x - 3, y - 3, 6, 15);
                }
            }

            // Draw boss
            if (boss) {
                if (boss.type === 'ball_boss') {
                    // Ball boss rendering (existing code)
                    if (boss.hp <= boss.maxHP * 0.3) {
                        ctx.fillStyle = '#8B0000';
                    } else if (boss.hp <= boss.maxHP * 0.6) {
                        ctx.fillStyle = '#DC143C';
                    } else {
                        ctx.fillStyle = '#FF0000';
                    }
                    
                    ctx.beginPath();
                    ctx.arc(boss.x, boss.y, boss.width/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    if (boss.phase >= 2) {
                        ctx.shadowColor = '#00FF00';
                        ctx.shadowBlur = 10;
                    }
                    
                    ctx.fillStyle = '#00FF00';
                    ctx.fillRect(boss.x - 15, boss.y - 15, 12, 12);
                    ctx.fillRect(boss.x + 3, boss.y - 15, 12, 12);
                    
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(boss.x - 10, boss.y - 10, 4, 4);
                    ctx.fillRect(boss.x + 8, boss.y - 10, 4, 4);
                    
                    ctx.shadowBlur = 0;
                } else if (boss.type === 'snake_boss') {
                    // NOVO: Snake boss rendering melhorado
                    boss.segments.forEach((segment, index) => {
                        if (segment.destroyed) {
                            // Draw destroyed segment as debris
                            ctx.fillStyle = '#654321';
                            for (let i = 0; i < 3; i++) {
                                const debrisX = segment.x + (Math.random() - 0.5) * 20;
                                const debrisY = segment.y + (Math.random() - 0.5) * 20;
                                ctx.fillRect(debrisX, debrisY, 5, 5);
                            }
                            return;
                        }
                        
                        if (index === boss.segments.length - 1) {
                            // Head - with vulnerability visual
                            if (boss.headVulnerable) {
                                ctx.fillStyle = '#8B0000'; // Dark red when vulnerable
                                ctx.shadowColor = '#FF0000';
                                ctx.shadowBlur = 15;
                            } else {
                                ctx.fillStyle = boss.hp <= boss.maxHP * 0.3 ? '#1F5F1F' : '#228B22';
                                ctx.shadowBlur = 0;
                            }
                            
                            ctx.fillRect(segment.x, segment.y, 35, 35);
                            ctx.shadowBlur = 0;
                            
                            // Eyes
                            ctx.fillStyle = boss.headVulnerable ? '#FFFF00' : '#FF0000';
                            ctx.fillRect(segment.x + 5, segment.y + 8, 8, 8);
                            ctx.fillRect(segment.x + 22, segment.y + 8, 8, 8);
                            
                            // Mouth
                            ctx.fillStyle = '#000000';
                            ctx.fillRect(segment.x + 10, segment.y + 20, 15, 3);
                            
                            // Health bar for head
                            if (boss.headVulnerable) {
                                const headHealthPercent = segment.hp / segment.maxHP;
                                ctx.fillStyle = '#000000';
                                ctx.fillRect(segment.x - 5, segment.y - 15, 45, 8);
                                ctx.fillStyle = '#FF0000';
                                ctx.fillRect(segment.x - 3, segment.y - 13, 41 * headHealthPercent, 4);
                            }
                        } else {
                            // Body segments with health indication
                            const healthPercent = segment.hp / segment.maxHP;
                            if (healthPercent > 0.7) {
                                ctx.fillStyle = boss.hp <= boss.maxHP * 0.3 ? '#228B22' : '#32CD32';
                            } else if (healthPercent > 0.3) {
                                ctx.fillStyle = '#6B8E23';
                            } else {
                                ctx.fillStyle = '#556B2F';
                            }
                            
                            ctx.fillRect(segment.x, segment.y, 25, 25);
                            
                            // Segment pattern
                            ctx.fillStyle = '#1F5F1F';
                            ctx.fillRect(segment.x + 5, segment.y + 5, 15, 3);
                            ctx.fillRect(segment.x + 5, segment.y + 12, 15, 3);
                            ctx.fillRect(segment.x + 5, segment.y + 19, 15, 3);
                            
                            // Mini health bar for segments
                            const segmentHealthPercent = segment.hp / segment.maxHP;
                            ctx.fillStyle = '#000000';
                            ctx.fillRect(segment.x + 2, segment.y - 8, 21, 4);
                            ctx.fillStyle = segmentHealthPercent > 0.5 ? '#00FF00' : '#FFFF00';
                            ctx.fillRect(segment.x + 3, segment.y - 7, 19 * segmentHealthPercent, 2);
                        }
                    });
                }
            }

            // Draw bombs
            ctx.fillStyle = '#FF4500';
            bombs.forEach(bomb => {
                if (!bomb.destroyed) {
                    ctx.beginPath();
                    ctx.arc(bomb.x, bomb.y, 15, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(bomb.x - 2, bomb.y - 20, 4, 10);
                    ctx.fillStyle = '#FF4500';
                }
            });

            // Draw bullets
            ctx.fillStyle = '#FFFF00';
            bullets.forEach(bullet => {
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.strokeStyle = '#FF8C00';
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // Draw vines
            vines.forEach(vine => {
                if (!vine.triggered) {
                    // Hidden vine trap
                    ctx.fillStyle = '#8FBC8F';
                    ctx.fillRect(vine.x - 15, vine.y - 10, 30, 20);
                    
                    // Subtle plant pattern
                    ctx.fillStyle = '#228B22';
                    ctx.fillRect(vine.x - 8, vine.y - 5, 3, 10);
                    ctx.fillRect(vine.x, vine.y - 5, 3, 10);
                    ctx.fillRect(vine.x + 8, vine.y - 5, 3, 10);
                } else {
                    // Activated vine trap
                    ctx.fillStyle = '#228B22';
                    ctx.fillRect(vine.x - 20, vine.y - 15, 40, 25);
                    
                    // Tentacle-like vines
                    for (let i = 0; i < 6; i++) {
                        const angle = (i / 6) * Math.PI * 2;
                        const tx = vine.x + Math.cos(angle) * 30;
                        const ty = vine.y + Math.sin(angle) * 30;
                        ctx.fillRect(tx - 3, ty - 15, 6, 30);
                    }
                }
            });

            // Draw spaceships
            spaceships.forEach(spaceship => {
                // Spaceship body
                ctx.fillStyle = '#666666';
                ctx.fillRect(spaceship.x - 30, spaceship.y - 15, 60, 30);
                ctx.fillRect(spaceship.x - 20, spaceship.y - 25, 40, 10);
                
                // Spaceship details
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(spaceship.x - 25, spaceship.y - 5, 8, 8);
                ctx.fillRect(spaceship.x - 10, spaceship.y - 5, 8, 8);
                ctx.fillRect(spaceship.x + 5, spaceship.y - 5, 8, 8);
                ctx.fillRect(spaceship.x + 20, spaceship.y - 5, 8, 8);
                
                // Laser warning indicator mira no jogador
                if (spaceship.laserWarning) {
                    ctx.fillStyle = '#FF0000';
                    ctx.globalAlpha = 0.5;
                    
                    // Calcular dire√ß√£o para o jogador
                    const dx = (player.x + player.width/2) - spaceship.x;
                    const dy = (player.y + player.height/2) - spaceship.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 0) {
                        const length = 200;
                        const endX = spaceship.x + (dx / distance) * length;
                        const endY = spaceship.y + (dy / distance) * length;
                        
                        // Desenhar linha de aviso
                        ctx.lineWidth = 10;
                        ctx.strokeStyle = '#FF0000';
                        ctx.beginPath();
                        ctx.moveTo(spaceship.x, spaceship.y + 15);
                        ctx.lineTo(endX, endY);
                        ctx.stroke();
                    }
                    
                    ctx.globalAlpha = 1;
                }
            });

            // Draw enemies
            enemies.forEach(enemy => {
                if (enemy.type === 'small') {
                    ctx.fillStyle = '#0000FF';
                    ctx.fillRect(enemy.x - 10, enemy.y - 10, 20, 20);
                } else if (enemy.type === 'big') {
                    ctx.fillStyle = '#0000FF';
                    ctx.fillRect(enemy.x - 20, enemy.y - 20, 40, 40);
                    ctx.fillStyle = '#FF0000';
                    ctx.fillRect(enemy.x - 15, enemy.y - 15, 8, 8);
                    ctx.fillRect(enemy.x + 7, enemy.y - 15, 8, 8);
                } else if (enemy.type === 'rolling') {
                    ctx.fillStyle = '#00AA00';
                    ctx.fillRect(enemy.x - 15, enemy.y - 15, 30, 30);
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(enemy.x - 25, enemy.y);
                    ctx.lineTo(enemy.x - 35, enemy.y);
                    ctx.stroke();
                } else if (enemy.type === 'minion') {
                    ctx.fillStyle = '#FFA500';
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, 10, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(enemy.x - 5, enemy.y - 5, 3, 3);
                    ctx.fillRect(enemy.x + 2, enemy.y - 5, 3, 3);
                } else if (enemy.type === 'rectangle') {
                    ctx.fillStyle = '#32CD32';
                    ctx.fillRect(enemy.x - 20, enemy.y - 15, 40, 30);
                    
                    ctx.shadowColor = '#8A2BE2';
                    ctx.shadowBlur = 5;
                    ctx.fillStyle = '#8A2BE2';
                    ctx.fillRect(enemy.x - 12, enemy.y - 8, 8, 8);
                    ctx.fillRect(enemy.x + 4, enemy.y - 8, 8, 8);
                    ctx.shadowBlur = 0;
                    
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(enemy.x - 22, enemy.y - 25, 44, 6);
                    ctx.fillStyle = '#FF0000';
                    ctx.fillRect(enemy.x - 20, enemy.y - 23, 40, 2);
                    ctx.fillStyle = '#00FF00';
                    const hpPercent = enemy.hp / 3;
                    ctx.fillRect(enemy.x - 20, enemy.y - 23, 40 * hpPercent, 2);
                }
            });

            // Draw enemy bullets
            if (window.enemyBullets) {
                window.enemyBullets.forEach(bullet => {
                    if (bullet.laser) {
                        ctx.fillStyle = '#FF0000';
                        ctx.shadowColor = '#FF0000';
                        ctx.shadowBlur = 10;
                    } else {
                        ctx.fillStyle = bullet.poison ? '#8A2BE2' : '#FF0000';
                        ctx.shadowBlur = 0;
                    }
                    
                    ctx.beginPath();
                    ctx.arc(bullet.x, bullet.y, bullet.laser ? 6 : 4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    if (bullet.poison) {
                        ctx.strokeStyle = '#9932CC';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                    
                    ctx.shadowBlur = 0;
                });
            }

            // Render part√≠culas
            renderParticles();

            // Draw floating texts
            ctx.font = '12px "Press Start 2P"';
            ctx.textAlign = 'center';
            floatingTexts.forEach(text => {
                ctx.globalAlpha = text.opacity;
                ctx.fillStyle = text.color;
                ctx.fillText(text.text, text.x, text.y);
            });
            ctx.globalAlpha = 1;

            // Draw aim indicator
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 2;
            ctx.beginPath();
            const aimX = player.x + player.width/2 + player.aimDirection.x * 30;
            const aimY = player.y + player.height/2 + player.aimDirection.y * 30;
            ctx.moveTo(player.x + player.width/2, player.y + player.height/2);
            ctx.lineTo(aimX, aimY);
            ctx.stroke();
            
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.arc(aimX, aimY, 4, 0, Math.PI * 2);
            ctx.fill();
        }

        function shoot() {
            const currentTime = Date.now();
            if (!window.lastShot || currentTime - window.lastShot > 200) {
                bullets.push({
                    x: player.x + player.width/2,
                    y: player.y + player.height/2,
                    dx: player.aimDirection.x,
                    dy: player.aimDirection.y
                });
                window.lastShot = currentTime;
                
                createParticles(player.x + player.width/2, player.y + player.height/2, '#FFFF00', 3);
            }
        }

        function spawnSmallEnemy() {
            enemies.push({
                type: 'small',
                x: Math.random() * (canvas.width - 40) + 20,
                y: 20,
                hp: 1,
                speed: 0.7
            });
        }

        function spawnBigEnemy() {
            enemies.push({
                type: 'big',
                x: Math.random() * (canvas.width - 120) + 60,
                y: Math.random() * 150 + 80,
                hp: 2,
                speed: 0,
                lastShot: 0
            });
        }

        function spawnRollingEnemy() {
            const side = Math.random() < 0.5 ? 'left' : 'right';
            const x = side === 'left' ? -30 : canvas.width + 30;
            const direction = side === 'left' ? 1 : -1;
            
            enemies.push({
                type: 'rolling',
                x: x,
                y: canvas.height - 100,
                hp: 3,
                speed: 1.2,
                direction: direction
            });
        }

        function shootEnemyBullet(enemy) {
            if (!window.enemyBullets) window.enemyBullets = [];
            
            const dx = (player.x + player.width/2) - enemy.x;
            const dy = (player.y + player.height/2) - enemy.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            window.enemyBullets.push({
                x: enemy.x,
                y: enemy.y,
                dx: dx / distance,
                dy: dy / distance
            });
            
            createParticles(enemy.x, enemy.y, '#FF0000', 3);
        }

        // CORRIGIDO: Sistema de pause melhorado
        function togglePause() {
            if (!gameState.gameRunning || gameState.cutsceneActive) return;
            
            gameState.paused = !gameState.paused;
            if (gameState.paused) {
                document.getElementById('pauseMenu').classList.remove('hidden');
            } else {
                document.getElementById('pauseMenu').classList.add('hidden');
            }
        }

        function quitGame() {
            gameState.gameRunning = false;
            gameState.paused = false;
            document.getElementById('pauseMenu').classList.add('hidden');
            showScreen('menu');
        }

        function gameOver() {
            gameState.gameRunning = false;
            
            createParticles(player.x + player.width/2, player.y + player.height/2, '#FF0000', 20);
            
            alert('Game Over! Voc√™ foi derrotado!');
            showScreen('menu');
        }

        function winLevel() {
            gameState.gameRunning = false;
            
            createParticles(player.x + player.width/2, player.y + player.height/2, '#FFD700', 15);
            
            // Recompensas por n√≠vel ajustadas
            if (gameState.currentLevel === 1) {
                gameState.level1Completed = true;
                gameState.money += 100;
                
                gameState.cutsceneActive = true;
                document.getElementById('cutsceneOverlay').classList.remove('hidden');
                document.getElementById('cutsceneContent').textContent = '"Volto j√°, aproveita seu tempo!" - Blue entra na nave e vai embora.';
                
                setTimeout(() => {
                    gameState.cutsceneActive = false;
                    document.getElementById('cutsceneOverlay').classList.add('hidden');
                    alert('Parab√©ns! Voc√™ completou a Fase 1! +100 üí∞\nFase 2 desbloqueada!');
                    saveGame();
                    showScreen('menu');
                }, 3000);
            } else if (gameState.currentLevel === 2) {
                gameState.level2Completed = true;
                gameState.money += 150;
                
                // Level 2 completion cutscene
                gameState.cutsceneActive = true;
                document.getElementById('cutsceneOverlay').classList.remove('hidden');
                
                let cutsceneCanvas = document.createElement('canvas');
                cutsceneCanvas.width = 400;
                cutsceneCanvas.height = 300;
                cutsceneCanvas.style.border = '2px solid white';
                cutsceneCanvas.style.borderRadius = '8px';
                
                const cutsceneCtx = cutsceneCanvas.getContext('2d');
                
                cutsceneCtx.fillStyle = '#87CEEB';
                cutsceneCtx.fillRect(0, 0, 400, 300);
                
                cutsceneCtx.fillStyle = '#808080';
                cutsceneCtx.fillRect(150, 100, 100, 40);
                cutsceneCtx.fillRect(175, 80, 50, 20);
                
                cutsceneCtx.fillStyle = '#FFB6C1';
                for (let i = 0; i < 6; i++) {
                    cutsceneCtx.beginPath();
                    cutsceneCtx.arc(160 + i * 15, 120, 5, 0, Math.PI * 2);
                    cutsceneCtx.fill();
                }
                
                cutsceneCtx.fillStyle = '#0066CC';
                cutsceneCtx.fillRect(185, 90, 30, 30);
                
                const contentDiv = document.getElementById('cutsceneContent');
                contentDiv.innerHTML = '';
                contentDiv.appendChild(cutsceneCanvas);
                
                const textDiv = document.createElement('div');
                textDiv.textContent = '"Eles v√£o dar uma visitinha num planeta diferente!" - Blue voa para longe com as bolas capturadas.';
                textDiv.className = 'text-white pixel-font text-sm text-center mt-4';
                contentDiv.appendChild(textDiv);
                
                setTimeout(() => {
                    gameState.cutsceneActive = false;
                    document.getElementById('cutsceneOverlay').classList.add('hidden');
                    alert('Parab√©ns! Voc√™ completou a Fase 2! +150 üí∞\nFase 3 desbloqueada!');
                    saveGame();
                    showScreen('menu');
                }, 4000);
            } else if (gameState.currentLevel === 3) {
                gameState.level3Completed = true;
                gameState.money += 300;
                
                // Level 3 completion cutscene
                gameState.cutsceneActive = true;
                document.getElementById('cutsceneOverlay').classList.remove('hidden');
                
                let cutsceneCanvas = document.createElement('canvas');
                cutsceneCanvas.width = 400;
                cutsceneCanvas.height = 300;
                cutsceneCanvas.style.border = '2px solid white';
                cutsceneCanvas.style.borderRadius = '8px';
                
                const cutsceneCtx = cutsceneCanvas.getContext('2d');
                
                cutsceneCtx.fillStyle = '#FFB6C1';
                cutsceneCtx.fillRect(0, 0, 400, 300);
                
                cutsceneCtx.fillStyle = '#C0C0C0';
                cutsceneCtx.fillRect(150, 80, 100, 120);
                
                cutsceneCtx.fillStyle = '#32CD32';
                cutsceneCtx.beginPath();
                cutsceneCtx.arc(200, 150, 15, 0, Math.PI * 2);
                cutsceneCtx.fill();
                
                cutsceneCtx.fillStyle = '#8A2BE2';
                cutsceneCtx.globalAlpha = 0.8;
                cutsceneCtx.beginPath();
                cutsceneCtx.arc(200, 160, 25, 0, Math.PI * 2);
                cutsceneCtx.fill();
                cutsceneCtx.globalAlpha = 1;
                
                const contentDiv = document.getElementById('cutsceneContent');
                contentDiv.innerHTML = '';
                contentDiv.appendChild(cutsceneCanvas);
                
                const textDiv = document.createElement('div');
                textDiv.textContent = '"Est√° bem, voc√™ pode usar a m√°quina. Boa sorte!" - A Bola Dona permite o acesso e voc√™ parte para o planeta quadrado.';
                textDiv.className = 'text-white pixel-font text-sm text-center mt-4';
                contentDiv.appendChild(textDiv);
                
                setTimeout(() => {
                    gameState.cutsceneActive = false;
                    document.getElementById('cutsceneOverlay').classList.add('hidden');
                    alert('Parab√©ns! Voc√™ completou a Fase 3! +300 üí∞\nFase 4 desbloqueada!');
                    saveGame();
                    showScreen('menu');
                }, 4000);
            } else if (gameState.currentLevel === 4) {
                gameState.level4Completed = true;
                gameState.money += 200;
                
                // Level 4 completion cutscene
                gameState.cutsceneActive = true;
                document.getElementById('cutsceneOverlay').classList.remove('hidden');
                
                let cutsceneCanvas = document.createElement('canvas');
                cutsceneCanvas.width = 400;
                cutsceneCanvas.height = 300;
                cutsceneCanvas.style.border = '2px solid white';
                cutsceneCanvas.style.borderRadius = '8px';
                
                const cutsceneCtx = cutsceneCanvas.getContext('2d');
                
                cutsceneCtx.fillStyle = '#228B22';
                cutsceneCtx.fillRect(0, 0, 400, 300);
                
                cutsceneCtx.fillStyle = '#8B4513';
                cutsceneCtx.fillRect(150, 100, 100, 200);
                cutsceneCtx.fillRect(175, 80, 50, 20);
                cutsceneCtx.fillRect(190, 60, 20, 20);
                cutsceneCtx.fillRect(195, 40, 10, 20);
                
                cutsceneCtx.fillStyle = '#32CD32';
                cutsceneCtx.beginPath();
                cutsceneCtx.arc(200, 250, 15, 0, Math.PI * 2);
                cutsceneCtx.fill();
                
                const contentDiv = document.getElementById('cutsceneContent');
                contentDiv.innerHTML = '';
                contentDiv.appendChild(cutsceneCanvas);
                
                const textDiv = document.createElement('div');
                textDiv.textContent = 'O jogador v√™ um caminho gigantesco que ter√° que atravessar... "Vai ser uma longa jornada"';
                textDiv.className = 'text-white pixel-font text-sm text-center mt-4';
                contentDiv.appendChild(textDiv);
                
                setTimeout(() => {
                    gameState.cutsceneActive = false;
                    document.getElementById('cutsceneOverlay').classList.add('hidden');
                    alert('Parab√©ns! Voc√™ completou a Fase 4! +200 üí∞\nMundo 2 desbloqueado!');
                    saveGame();
                    showScreen('menu');
                }, 4000);
            } else if (gameState.currentLevel === 5) {
                gameState.world2Level1Completed = true;
                gameState.money += 150;
                
                // World 2 Level 1 completion cutscene
                gameState.cutsceneActive = true;
                document.getElementById('cutsceneOverlay').classList.remove('hidden');
                
                let cutsceneCanvas = document.createElement('canvas');
                cutsceneCanvas.width = 400;
                cutsceneCanvas.height = 300;
                cutsceneCanvas.style.border = '2px solid white';
                cutsceneCanvas.style.borderRadius = '8px';
                
                const cutsceneCtx = cutsceneCanvas.getContext('2d');
                
                // Village scene
                cutsceneCtx.fillStyle = '#8FBC8F';
                cutsceneCtx.fillRect(0, 0, 400, 300);
                
                // Village buildings
                cutsceneCtx.fillStyle = '#8B4513';
                cutsceneCtx.fillRect(50, 150, 80, 100);
                cutsceneCtx.fillRect(180, 140, 90, 110);
                cutsceneCtx.fillRect(320, 160, 70, 90);
                
                // Square inhabitants
                cutsceneCtx.fillStyle = '#90EE90';
                cutsceneCtx.fillRect(80, 200, 20, 20);
                cutsceneCtx.fillRect(200, 190, 20, 20);
                cutsceneCtx.fillRect(340, 210, 20, 20);
                
                // Player talking
                cutsceneCtx.fillStyle = '#32CD32';
                cutsceneCtx.beginPath();
                cutsceneCtx.arc(150, 220, 15, 0, Math.PI * 2);
                cutsceneCtx.fill();
                
                const contentDiv = document.getElementById('cutsceneContent');
                contentDiv.innerHTML = '';
                contentDiv.appendChild(cutsceneCanvas);
                
                const textDiv = document.createElement('div');
                textDiv.textContent = '"Sim, vimos naves estranhas por aqui. Elas levaram algumas das nossas amigas bolas!" - Habitantes da vila';
                textDiv.className = 'text-white pixel-font text-sm text-center mt-4';
                contentDiv.appendChild(textDiv);
                
                setTimeout(() => {
                    gameState.cutsceneActive = false;
                    document.getElementById('cutsceneOverlay').classList.add('hidden');
                    alert('Parab√©ns! Voc√™ completou a Fase 5! +150 üí∞\nFase 6 desbloqueada!');
                    saveGame();
                    showScreen('world2Select');
                }, 4000);
            } else if (gameState.currentLevel === 6) {
                gameState.world2Level2Completed = true;
                gameState.money += 200;
                
                alert(`Parab√©ns! Voc√™ completou a Fase 6! +200 üí∞\nBolas salvas: ${gameState.ballsSaved}`);
                saveGame();
                showScreen('world2Select');
            } else if (gameState.currentLevel === 7) {
                gameState.world2Level3Completed = true;
                gameState.money += 300;
                
                alert('Parab√©ns! Voc√™ completou a Fase 7! +300 üí∞\nA resist√™ncia continua!');
                saveGame();
                showScreen('world2Select');
            } else if (gameState.currentLevel === 8) {
                gameState.world2Level4Completed = true;
                gameState.money += 500;
                
                // Epic boss completion cutscene
                gameState.cutsceneActive = true;
                document.getElementById('cutsceneOverlay').classList.remove('hidden');
                
                let cutsceneCanvas = document.createElement('canvas');
                cutsceneCanvas.width = 400;
                cutsceneCanvas.height = 300;
                cutsceneCanvas.style.border = '2px solid white';
                cutsceneCanvas.style.borderRadius = '8px';
                
                const cutsceneCtx = cutsceneCanvas.getContext('2d');
                
                // Snake dying and releasing energy
                cutsceneCtx.fillStyle = '#1a1a1a';
                cutsceneCtx.fillRect(0, 0, 400, 300);
                
                // Energy explosion
                cutsceneCtx.fillStyle = '#FFD700';
                for (let i = 0; i < 10; i++) {
                    cutsceneCtx.beginPath();
                    cutsceneCtx.arc(200, 150, 20 + i * 10, 0, Math.PI * 2);
                    cutsceneCtx.globalAlpha = 0.3;
                    cutsceneCtx.fill();
                }
                cutsceneCtx.globalAlpha = 1;
                
                // Portal to third world
                cutsceneCtx.fillStyle = '#8A2BE2';
                cutsceneCtx.beginPath();
                cutsceneCtx.arc(200, 150, 50, 0, Math.PI * 2);
                cutsceneCtx.fill();
                
                const contentDiv = document.getElementById('cutsceneContent');
                contentDiv.innerHTML = '';
                contentDiv.appendChild(cutsceneCanvas);
                
                const textDiv = document.createElement('div');
                textDiv.textContent = 'A Cobra dos Quadrados √© derrotada! Um portal para o Terceiro Mundo se abre!';
                textDiv.className = 'text-white pixel-font text-sm text-center mt-4';
                contentDiv.appendChild(textDiv);
                
                setTimeout(() => {
                    gameState.cutsceneActive = false;
                    document.getElementById('cutsceneOverlay').classList.add('hidden');
                    alert('√âPICO! Voc√™ completou a Fase 8! +500 üí∞\nTerceiro Mundo desbloqueado! (Em desenvolvimento)');
                    saveGame();
                    showScreen('menu');
                }, 4000);
            }
            
            updateMoneyDisplay();
            updateBallsDisplay();
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            setupMobileControls();
            setupMobileNavigation(); // NOVO: Setup navega√ß√£o mobile
            
            // Load saved game
            loadGame();
            
            updateMoneyDisplay();
            updateBallsDisplay();
            updateAchievementsScreen();
            updateShopDisplay();
        });
    </script>
</body>
</html